---
title: 线程池、溢出、异常、阻塞，奇怪的 C++ 服务重启问题定位
tags:
  - C++
category: 程序设计
toc: true
description: 
date: 
---

最近在业务中遇见一个很奇怪的服务重启问题，定位过程比较有曲折，本文来复盘下。这个问题涉及到 C++ 线程池、整数溢出、异常捕获、阻塞等多个方面，还是挺有意思的。

接下来我会按照**问题排查的过程**来组织本文内容，会先介绍问题背景，接着列出初步的排查思路，定位异常请求的方法。然后，通过代码分析，以及复现问题的一些简单用例，来揭开服务重启的神秘面纱。

<!-- more -->

## 问题背景

我们有个模块 A 对外提供 RPC 服务，主调方 B 会调用 A 的服务。主调方 B 最近发现每天会有几次连不上服务 A 的端口，每次持续时间也不长，会自动恢复。

于是查看模块日志，发现在对应时间点，**监控脚本拨测 A 服务失败，于是重启服务**。按照经验，拨测失败一般是服务进程挂了，比如 coredump 了，或者内存泄露导致 OOM 被系统杀了。但是查了下服务监控，并不是上面两种情况。CPU 和内存使用在重启时间段都是正常的，也没看到有 coredump 相关日志。

## 初步分析排查

## 定位异常请求


## 初步代码分析


## 多线程：thread 

### 阻塞？

## 多线程：async 

### 异常捕获

### 水落石出

## 总结

