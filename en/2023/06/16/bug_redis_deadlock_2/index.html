<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Redis Deadlock Problem Caused by Stream Data Read and Write (2)</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924" data-domains="selfboot.cn"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Redis Deadlock Problem Caused by Stream Data Read and Write (2)</h1><div class="post-meta">2023/06/16<span> | </span><span class="category"><a href="/categories/Source-Code-Analysis/">Source Code Analysis</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2023/06/16/bug_redis_deadlock_2/" href="/en/2023/06/16/bug_redis_deadlock_2/#disqus_thread"></a><div class="post-content"><p>In <a href="https://selfboot.cn/en/2023/06/14/bug_redis_deadlock_1/">Redis Issue Analysis: “Deadlock” Problem Caused by Stream Data Read and Write (1)</a>, we successfully reproduced the bug mentioned in the Issue, observing that the Redis Server CPU spiked, unable to establish new connections, and existing connections couldn’t perform any read or write operations. With the help of powerful eBPF profile tools, we observed where the CPU time was mainly consumed. Now, let’s take a look at the debugging process and fix for this bug.</p>
<h2 id="Debugging-the-bug"><a href="#Debugging-the-bug" class="headerlink" title="Debugging the bug"></a>Debugging the bug</h2><p>Considering that the Redis server process is still running, we can use GDB to attach to the process and set breakpoints to see the specific execution process. In the flame graph, we saw that the time-consuming <code>handleClientsBlockedOnKey</code> function contains a while loop statement. Since CPU spikes are usually caused by infinite loops, to verify if there’s an infinite loop in this while statement, we can set breakpoints at line 565 before the while loop and line 569 inside it, then <code>continue</code> multiple times to observe.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>((ln = listNext(&amp;li))) {</span><br><span class="line">    client *receiver = listNodeValue(ln);</span><br><span class="line">    robj *o = lookupKeyReadWithFlags(rl-&gt;db, rl-&gt;key, LOOKUP_NOEFFECTS);</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<span id="more"></span>

<p>We see that <strong>it always pauses at line 569 inside the loop</strong>, basically confirming that an infinite loop is occurring here. Looking at the local variables on the current stack frame, we can see the receiver pointer. Specifically:<br><img src="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_0.png/webp" alt="GDB continue confirms infinite loop" srcset="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_0.png/webp 2420w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_0.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_0.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_0.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2420" height="1324"></p>
<p>Here, receiver is a struct client declared in <code>server.h</code>, which is the data structure maintained by Redis for each client connection. The problem is now clear: the server process keeps taking out client connections in the while loop and can’t stop. To understand where these clients come from, we can print the name field in the client.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">client</span> {</span></span><br><span class="line">    ...</span><br><span class="line">    robj *name;             <span class="comment">/* As set by CLIENT SETNAME. */</span></span><br><span class="line">    ...</span><br><span class="line">} client;</span><br></pre></td></tr></tbody></table></figure>

<p>However, this needs to be set when the client connects, so let’s modify our test script from <a href="https://selfboot.cn/2023/06/14/bug_redis_deadlock_1/">Redis Issue Analysis: “Deadlock” Problem Caused by Stream Data Read and Write (1)</a>, restart the server, run the reproduction process, and then re-analyze with GDB.</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">subscriber</span>(<span class="params">user_id</span>):</span><br><span class="line">    r = Redis(unix_socket_path=<span class="string">'/run/redis-server.sock'</span>)</span><br><span class="line">    r.client_setname(<span class="string">f'subscriber_<span class="subst">{user_id}</span>'</span>)   <span class="comment"># Set client name here</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ...</span><br></pre></td></tr></tbody></table></figure>

<p>GDB prints out the receiver’s name as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *receiver-&gt;name</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">6 = {<span class="built_in">type</span> = 0, encoding = 8, lru = 9013978, refcount = 1, ptr = 0x7f8b17899213}</span></span><br></pre></td></tr></tbody></table></figure>

<p>Here, name is a redisObject. Based on type=0 and encoding=8, we know that this name is actually a string, stored in memory at the ptr pointer.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// object.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_STRING 0    <span class="comment">/* String object. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_ENCODING_EMBSTR 8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> {</span></span><br><span class="line">    <span class="type">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="type">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="type">int</span> refcount;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>Then we can use <code>p (char *)receiver-&gt;name-&gt;ptr</code> to print the specific name of the client. Here we need to print the client name multiple times continuously to see what client is taken out each time. To print automatically multiple times, we can use the commands instruction in GDB, as shown in the following image:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_1.png/webp" alt="GDB continue observes clients here" srcset="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_1.png/webp 2438w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_1.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_1.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_1.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2438" height="1572"></p>
<p>In fact, <code>subscriber_1</code> and <code>subscriber_2</code> are always taken out from the queue alternately, endlessly, so it can’t break out of the loop.</p>
<h2 id="Fix-the-code"><a href="#Fix-the-code" class="headerlink" title="Fix the code"></a>Fix the code</h2><p>The fix used here is a rather tricky method, ensuring that only the clients currently in the queue at this moment are processed, and newly added clients are not processed. The specific commit is <a target="_blank" rel="noopener" href="https://github.com/redis/redis/blob/e7129e43e0c7c85921666018b68f5b729218d31e/src/blocked.c">commit e7129e43e0c7c85921666018b68f5b729218d31e</a>, and the commit message describes this issue:</p>
<blockquote>
<p>Author: Binbin <a href="mailto:binloveplay1314@qq.com">binloveplay1314@qq.com</a><br>Date:   Tue Jun 13 18:27:05 2023 +0800<br>   Fix XREADGROUP BLOCK stuck in endless loop (#12301)  </p>
<p>   For the XREADGROUP BLOCK &gt; scenario, there is an endless loop.<br>   Due to #11012, it keep going, reprocess command -&gt; blockForKeys -&gt; reprocess command</p>
<p>   The right fix is to avoid an endless loop in handleClientsBlockedOnKey and handleClientsBlockedOnKeys,<br>   looks like there was some attempt in handleClientsBlockedOnKeys but maybe not sufficiently good,<br>   and it looks like using a similar trick in handleClientsBlockedOnKey is complicated.<br>   i.e. stashing the list on the stack and iterating on it after creating a fresh one for future use,<br>   is problematic since the code keeps accessing the global list.  </p>
<p>   Co-authored-by: Oran Agra <a href="mailto:oran@redislabs.com">oran@redislabs.com</a>  </p>
</blockquote>
<p>The changes in the commit are relatively minor, as shown below:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_2.png/webp" alt="Fix code comparison" srcset="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_2.png/webp 3456w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_2.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_2.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_2.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="3456" height="2158"></p>
<h3 id="When-are-elements-added-to-the-list"><a href="#When-are-elements-added-to-the-list" class="headerlink" title="When are elements added to the list?"></a>When are elements added to the list?</h3><p>There’s another question that needs to be clarified: when exactly are the clients that have been taken out of the queue put back into the queue? Because I’m not very familiar with the Redis source code, I couldn’t find the relevant code after looking for a while at first. I asked about this on the Issue, and <a target="_blank" rel="noopener" href="https://github.com/oranagra">oranagra</a> came out to explain that it’s in <code>blockForKeys</code> (actually, this function is mentioned in the commit message).</p>
<p>When I thought about this later, I realized I could have found it myself. Because the list is definitely continuously adding clients in the loop, and the function for adding elements to the tail of the list in Redis is easy to find, it’s <code>listAddNodeTail</code>:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// adlist.c</span></span><br><span class="line"><span class="function">list *<span class="title">listAddNodeTail</span><span class="params">(list *list, <span class="type">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    listNode *node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((node = <span class="built_in">zmalloc</span>(<span class="built_in">sizeof</span>(*node))) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;value = value;</span><br><span class="line">    <span class="built_in">listLinkNodeTail</span>(list, node);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>We just need to set a breakpoint on this function, and when it executes here, we can get the function stack and know the call relationship, as shown in the following image:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_3.png/webp" alt="Call chain for re-adding to the list" srcset="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_3.png/webp 2446w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_3.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_3.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_3.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2446" height="1540"></p>
<h3 id="Is-breaking-out-of-the-loop-enough"><a href="#Is-breaking-out-of-the-loop-enough" class="headerlink" title="Is breaking out of the loop enough?"></a>Is breaking out of the loop enough?</h3><p>There’s another question: in the fix solution here, during a single <code>handleClientsBlockedOnKey</code> function processing, the client will still be appended to the queue tail (there’s actually no change here). So why won’t these two clients be taken out again in the modified code?</p>
<p>TODO…(To be continued)</p>
<h2 id="Test-case"><a href="#Test-case" class="headerlink" title="Test case"></a>Test case</h2><p>The official team also added a <a target="_blank" rel="noopener" href="https://www.tcl.tk/">tcl</a> test case script, adding the following case in tests/unit/type/stream-cgroups.tcl:</p>
<figure class="highlight txt"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">test {Blocking XREADGROUP for stream key that has clients blocked on list - avoid endless loop} {</span><br><span class="line">    r DEL mystream</span><br><span class="line">    r XGROUP CREATE mystream mygroup $ MKSTREAM</span><br><span class="line"></span><br><span class="line">    set rd1 [redis_deferring_client]</span><br><span class="line">    set rd2 [redis_deferring_client]</span><br><span class="line">    set rd3 [redis_deferring_client]</span><br><span class="line"></span><br><span class="line">    $rd1 xreadgroup GROUP mygroup myuser COUNT 10 BLOCK 10000 STREAMS mystream &gt;</span><br><span class="line">    $rd2 xreadgroup GROUP mygroup myuser COUNT 10 BLOCK 10000 STREAMS mystream &gt;</span><br><span class="line">    $rd3 xreadgroup GROUP mygroup myuser COUNT 10 BLOCK 10000 STREAMS mystream &gt;</span><br><span class="line"></span><br><span class="line">    wait_for_blocked_clients_count 3</span><br><span class="line"></span><br><span class="line">    r xadd mystream MAXLEN 5000 * field1 value1 field2 value2 field3 value3</span><br><span class="line"></span><br><span class="line">    $rd1 close</span><br><span class="line">    $rd2 close</span><br><span class="line">    $rd3 close</span><br><span class="line"></span><br><span class="line">    assert_equal [r ping] {PONG}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The test logic here is basically the same as the reproduction script, creating 3 clients blocked in xreadgroup, and then using another client to add 3 sets of data. Then it closes the consumer clients and tries to send a ping message with the client that added data to see if there’s a pong reply. If this bug still exists, sending ping would not get any response.</p>
<p>You can run <code>./runtest --single unit/type/stream-cgroups</code> in the <a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases/tag/7.2-rc2">redis-7.2-rc2</a> directory to test this newly added case group. The execution result is as follows:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_4.png/webp" alt="Effectiveness of the added test case" srcset="https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_4.png/webp 2444w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_4.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_4.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230616_bug_redis_deadlock_2_4.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2444" height="1232"></p>
<p>After executing the group of test cases before the newly added one, the test case got stuck, and then we saw that the CPU usage of the Redis process was also 100%, indicating that this test case can fully reproduce this problem. Here’s an additional point: in the TCL test, the Redis binary file used is located in the src subdirectory of the Redis source code directory. Specifically, it’s found through the following command in the TCL script:</p>
<figure class="highlight tcl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> ::redis [<span class="keyword">file</span> normalize [<span class="keyword">file</span> <span class="keyword">join</span> [<span class="keyword">pwd</span>] ../src/redis-server]]</span><br></pre></td></tr></tbody></table></figure>

<p>It connects the parent directory of the current directory (i.e., the root directory of the Redis source code) with src/redis-server to form the complete path of the Redis binary file. This means it uses the Redis version you compiled yourself, not any version that might already be installed on the system.</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/Redis/"><i class="fa fa-tag"></i>Redis</a><a href="/tags/Debug/"><i class="fa fa-tag"></i>Debug</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2023/06/16/bug_redis_deadlock_2/';
    this.page.identifier = 'en/2023/06/16/bug_redis_deadlock_2/';
    this.page.title = 'Redis Deadlock Problem Caused by Stream Data Read and Write (2)';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });</script></div><script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
  var disqusThread = document.getElementById('disqus_thread');
  if (!disqusThread) return;
  
  function removeAdIframes() {
    var iframes = disqusThread.getElementsByTagName('iframe');
    for (var i = iframes.length - 1; i >= 0; i--) {
      var iframe = iframes[i];
      if (iframe.src && iframe.src.indexOf("tempest.services.disqus.com/ads-iframe") !== -1) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  }
  
  removeAdIframes();
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      removeAdIframes();
    });
  });
  observer.observe(disqusThread, { childList: true, subtree: true });
});
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget recommendations-widget"><div class="widget-title"> Recommended</div><div class="recommendations-container"><div class="recommendation-item"><a class="promo-link" href="https://puzzles-game.com/" target="_blank"><div class="promo-content"><i class="fa fa-gamepad"></i><span class="promo-text">Train Your Brain And Stay Smart</span></div></a></div><div class="recommendation-item"><a class="promo-link" href="https://gallery.selfboot.cn" target="_blank"><div class="promo-content"><i class="fa fa-robot"></i><span class="promo-text">Use AI And Help Me Make Things</span></div></a></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (21)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (14)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2023/06/16/bug_redis_deadlock_2/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/06/27/leveldb_source_table_build/" title="LevelDB Explained - A Step by Step Guide to SSTable Build">LevelDB Explained - A Step by Step Guide to SSTable Build</a></li><li><a href="/en/2025/06/13/leveldb_source_LRU_cache/" title="LevelDB Explained - The Implementation Details of a High-Performance LRU Cache">LevelDB Explained - The Implementation Details of a High-Performance LRU Cache</a></li><li><a href="/en/2025/06/11/leveldb_source_memtable/" title="LevelDB Explained - The Implementation Details of MemTable">LevelDB Explained - The Implementation Details of MemTable</a></li><li><a href="/en/2025/06/10/leveldb_mvcc_intro/" title="LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)">LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)</a></li><li><a href="/en/2025/05/23/mcp_user_report/" title="In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?">In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?</a></li><li><a href="/en/2025/01/24/leveldb_source_writedb/" title="LevelDB Explained - Implementation and Optimization Details of Key-Value Writing">LevelDB Explained - Implementation and Optimization Details of Key-Value Writing</a></li><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Debugging-the-bug"><span class="toc-number">1.</span> <span class="toc-text">Debugging the bug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fix-the-code"><span class="toc-number">2.</span> <span class="toc-text">Fix the code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#When-are-elements-added-to-the-list"><span class="toc-number">2.1.</span> <span class="toc-text">When are elements added to the list?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Is-breaking-out-of-the-loop-enough"><span class="toc-number">2.2.</span> <span class="toc-text">Is breaking out of the loop enough?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-case"><span class="toc-number">3.</span> <span class="toc-text">Test case</span></a></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p><p>Friend Link:<a rel="dofollow" target="_blank" href="https://puzzles-game.com/">Puzzle Games</a></p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><link rel="stylesheet" type="text/css" href="/css/recommendations.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>