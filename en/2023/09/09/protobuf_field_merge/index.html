<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This article reproduces a typical case using Go code, two services use different versions of Protobuf message definitions, where one service repeatedly merges old and new messages, causing the message size to continuously increase. It analyzes how the handling of unknown fields in the source code leads to the problem."><title>Analysis of Storage Failure Caused by Protobuf Serialized Messages</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924" data-domains="selfboot.cn"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Analysis of Storage Failure Caused by Protobuf Serialized Messages</h1><div class="post-meta">2023/09/09<span> | </span><span class="category"><a href="/categories/Programming/">Programming</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2023/09/09/protobuf_field_merge/" href="/en/2023/09/09/protobuf_field_merge/#disqus_thread"></a><div class="post-content"><p>Previously, I encountered a problem in actual business where Protobuf serialized messages caused storage failures. At that time, this issue almost led to a major failure, but I didn’t write an article to properly reflect on it. Recently, I encountered another Protobuf problem, and after writing <a href="https://selfboot.cn/en/2023/09/07/protobuf_redefine/">Investigating the Mysterious Field Loss Problem When Using Protobuf in C++</a>, I was reminded of the previous issue. Here, I’d like to write another article to properly introduce the pitfall I encountered last time.</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230910_protobuf_field_merge_summary.png/webp" alt="Analysis of Storage Failure Caused by Protobuf Serialized Messages" srcset="https://slefboot-1251736664.file.myqcloud.com/20230910_protobuf_field_merge_summary.png/webp 2172w, https://slefboot-1251736664.file.myqcloud.com/20230910_protobuf_field_merge_summary.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230910_protobuf_field_merge_summary.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230910_protobuf_field_merge_summary.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2172" height="1220"></p>
<span id="more"></span>

<h2 id="Failure-Review"><a href="#Failure-Review" class="headerlink" title="Failure Review"></a>Failure Review</h2><p>A certain HTTP request in the business consistently timed out. Through logs, we quickly located that a certain service reading from KV at the bottom layer had timed out, where reading from KV didn’t finish within 5 seconds. This was a core KV, with fine-grained monitoring, and the average latency and P99 were at the millisecond level. Such long latency had never occurred before.</p>
<p>Fortunately, the timeout for this key was consistently reproducible. For reproducible problems, it’s much easier to investigate. I directly wrote a tool, set the timeout a bit longer, so that we could read the complete content. Since what was stored here was serialized protobuf, after reading it out, we could directly deserialize it and use <code>DebugString</code> to print the content. Strangely, what was printed out were normal business proto fields, and the field content was very little, which shouldn’t have caused a timeout.</p>
<p>So I went back to review the timeout logs and found that the logs showed the size of the value read from KV was <strong>tens of megabytes</strong>, which explained the long latency. But why did DebugString only print out a few fields? To further confirm how large the serialized content read out was, I modified the tool further to output the size of the value, which was indeed tens of megabytes, matching the KV logs.</p>
<p>Tens of megabytes of content, but only a few fields output after deserialization, <strong>it might be that the proto wasn’t updated</strong>. So I asked a colleague and found out that a field had been added to this proto in the test branch, but it hadn’t been submitted yet. After getting the new proto, we deserialized it again and found a large amount of repetitive content in the newly added field. Further tracing the entire process, we found that the trigger for this problem was quite subtle:</p>
<ol>
<li>A new test module set a new proto field, serialized it, and stored it in KV;</li>
<li>In another old module, a new message was created, then merged with the pb read from KV, and written back to KV;</li>
<li>Each Merge operation would cause the message to expand, and after multiple calls, the size of this pb would become extremely large.</li>
</ol>
<p>To better demonstrate this problem, I’ll prepare a simple reproduction step below.</p>
<h2 id="Problem-Reproduction"><a href="#Problem-Reproduction" class="headerlink" title="Problem Reproduction"></a>Problem Reproduction</h2><p>The services in the business were implemented in C++, but to make it simpler here (and I’ve been learning to write Go recently), I’ll use Go to reproduce it. We need to simulate two microservices operating on a protobuf message:</p>
<ul>
<li>Service A (serverA below) depends on the proto file with newly added fields, where it will set new fields and then store the serialized pb in a file message.pb.</li>
<li>Service B (serverB below) is the old service, using the old proto file, where it will create a new message, then merge the pb read and deserialized from the above file;</li>
</ul>
<p>The old Proto is as follows:</p>
<figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> user;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">"./;user"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Info</span> {</span><br><span class="line">  <span class="type">string</span> page = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> title = <span class="number">2</span>;</span><br><span class="line">  <span class="type">int32</span> idx = <span class="number">3</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>In service A, a field <code>string content = 4;</code> was added to this proto, and operations are based on the new proto file.</p>
<h3 id="serverA"><a href="#serverA" class="headerlink" title="serverA"></a>serverA</h3><p>Below is the implementation of serverA, which is relatively simple. Note that it uses the new field:</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	newInfo := &amp;user.Info{</span><br><span class="line">		Page:    <span class="string">"example_page"</span>,</span><br><span class="line">		Title:   <span class="string">"example_title"</span>,</span><br><span class="line">		Idx:     <span class="number">1</span>,</span><br><span class="line">		Content: strings.Repeat(<span class="string">"example_content, "</span>, <span class="number">5</span>)[:<span class="built_in">len</span>(<span class="string">"example_content, "</span>)*<span class="number">5</span><span class="number">-2</span>], <span class="comment">// remove the last comma and space</span></span><br><span class="line">	}</span><br><span class="line">	data, err := proto.Marshal(newInfo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		log.Fatalf(<span class="string">"Marshaling error: %v"</span>, err)</span><br><span class="line">	}</span><br><span class="line">	err = ioutil.WriteFile(<span class="string">"message.pb"</span>, data, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		log.Fatalf(<span class="string">"Failed to write to file: %v"</span>, err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"Serialized data saved to message.pb"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>This simulates a very common use case in business: get a pb from KV (here, for simplicity, we directly create a new one), then set a new field and save it again.</p>
<h3 id="serverB"><a href="#serverB" class="headerlink" title="serverB"></a>serverB</h3><p>Next is the implementation of serverB. In this service, because it hasn’t been recompiled, it’s still using the old proto. This situation is quite common, after all, in actual business, there are often multiple services depending on the same proto file, and after updating the proto, not all services will be updated immediately.</p>
<p>The reproduction code here is also very simple, creating a new proto message, then merging the message saved to the file by serverA above. Note that the Merge is repeated in a loop, simulating the process that is continuously triggered in the business. The overall code is as follows. Here, just to demonstrate the core logic, the code for checking err at each step has been removed. In actual projects, it’s crucial to check for errors.</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fileName := <span class="string">"message.pb"</span></span><br><span class="line">	data, _ := ioutil.ReadFile(fileName)</span><br><span class="line"></span><br><span class="line">	initialInfo := &amp;user.Info{}</span><br><span class="line">	proto.Unmarshal(data, initialInfo)</span><br><span class="line"></span><br><span class="line">	newInfo := &amp;user.Info{</span><br><span class="line">		Page:  <span class="string">"page"</span>,</span><br><span class="line">		Title: <span class="string">"title"</span>,</span><br><span class="line">		Idx:   <span class="number">1</span>,</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ {</span><br><span class="line">		proto.Merge(newInfo, initialInfo)</span><br><span class="line">		mergedData, _ := proto.Marshal(newInfo)</span><br><span class="line">		fmt.Printf(<span class="string">"Iteration %d: Size(bytes) = %d \n"</span>, i+<span class="number">1</span>, <span class="built_in">len</span>(mergedData))</span><br><span class="line">		fmt.Printf(<span class="string">"Iteration %d: Content     = %v\n"</span>, i+<span class="number">1</span>, newInfo)</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>First, execute serverA to save the serialized pb to a file. Then execute serverB, read the file, deserialize it, and execute the subsequent loop operation. You can see the following output:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230909_protobuf_field_merge_reproduce.png/webp" alt="Continuously expanding pb message content" srcset="https://slefboot-1251736664.file.myqcloud.com/20230909_protobuf_field_merge_reproduce.png/webp 2408w, https://slefboot-1251736664.file.myqcloud.com/20230909_protobuf_field_merge_reproduce.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230909_protobuf_field_merge_reproduce.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230909_protobuf_field_merge_reproduce.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2408" height="1110"></p>
<p>The pb content here keeps expanding. In actual business, if this Merge process is continuously triggered, it will <strong>gradually lead</strong> to severe consequences. For example, it might fill up the KV storage space, or cause network transmission timeouts due to oversized content. Worse still, this <strong>process might be quite slow</strong>, possibly causing serious consequences several months after service A is deployed, making it even more difficult to troubleshoot.</p>
<h2 id="Source-Code-Analysis"><a href="#Source-Code-Analysis" class="headerlink" title="Source Code Analysis"></a>Source Code Analysis</h2><p>Using the Go language is comfortable; in VSCode, you can jump through the code, making it incredibly convenient to look at the code implementation of some third-party libraries. The implementation of <code>proto.Merge(newInfo, initialInfo)</code> above is as follows (google.golang.org/protobuf v1.31.0):</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Merge merges src into dst, which must be a message with the same descriptor.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Populated scalar fields in src are copied to dst, while populated</span></span><br><span class="line"><span class="comment">// singular messages in src are merged into dst by recursively calling Merge.</span></span><br><span class="line"><span class="comment">// The elements of every list field in src is appended to the corresponded</span></span><br><span class="line"><span class="comment">// list fields in dst. The entries of every map field in src is copied into</span></span><br><span class="line"><span class="comment">// the corresponding map field in dst, possibly replacing existing entries.</span></span><br><span class="line"><span class="comment">// The unknown fields of src are appended to the unknown fields of dst.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It is semantically equivalent to unmarshaling the encoded form of src</span></span><br><span class="line"><span class="comment">// into dst with the UnmarshalOptions.Merge option specified.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Merge</span><span class="params">(dst, src Message)</span></span> {</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Should nil src be treated as semantically equivalent to a</span></span><br><span class="line">	<span class="comment">// untyped, read-only, empty message? What about a nil dst?</span></span><br><span class="line"></span><br><span class="line">	dstMsg, srcMsg := dst.ProtoReflect(), src.ProtoReflect()</span><br><span class="line">	<span class="keyword">if</span> dstMsg.Descriptor() != srcMsg.Descriptor() {</span><br><span class="line">		<span class="keyword">if</span> got, want := dstMsg.Descriptor().FullName(), srcMsg.Descriptor().FullName(); got != want {</span><br><span class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"descriptor mismatch: %v != %v"</span>, got, want))</span><br><span class="line">		}</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"descriptor mismatch"</span>)</span><br><span class="line">	}</span><br><span class="line">	mergeOptions{}.mergeMessage(dstMsg, srcMsg)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The code comments in some classic open-source libraries are very well written. Note this comment:</p>
<blockquote>
<p>The unknown fields of src are appended to the unknown fields of dst.</p>
</blockquote>
<p>The content field value added by ServerA earlier is <code>unknown fields</code> for newInfo in ServerB (because the proto wasn’t updated here). Each time the Merge operation is executed, the content of content will be appended to the unknown fields of newInfo, causing the size to continuously expand. This append process is in the <code>mergeMessage</code> function above, specifically as follows (irrelevant code omitted):</p>
<figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o mergeOptions)</span></span> mergeMessage(dst, src protoreflect.Message) {</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">	src.Range(<span class="function"><span class="keyword">func</span><span class="params">(fd protoreflect.FieldDescriptor, v protoreflect.Value)</span></span> <span class="type">bool</span> {</span><br><span class="line">		<span class="keyword">switch</span> {</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			dst.Set(fd, v)</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	})</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(src.GetUnknown()) &gt; <span class="number">0</span> {</span><br><span class="line">		dst.SetUnknown(<span class="built_in">append</span>(dst.GetUnknown(), src.GetUnknown()...))</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>You can see that as long as src has an unknown field, the append operation will be executed. In fact, not just in Go, Proto’s Merge in C++ and Python also handles <code>unknown fields</code> in this way.</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/Debug/"><i class="fa fa-tag"></i>Debug</a><a href="/tags/Go/"><i class="fa fa-tag"></i>Go</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2023/09/09/protobuf_field_merge/';
    this.page.identifier = 'en/2023/09/09/protobuf_field_merge/';
    this.page.title = 'Analysis of Storage Failure Caused by Protobuf Serialized Messages';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });</script></div><script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
  var disqusThread = document.getElementById('disqus_thread');
  if (!disqusThread) return;
  
  function removeAdIframes() {
    var iframes = disqusThread.getElementsByTagName('iframe');
    for (var i = iframes.length - 1; i >= 0; i--) {
      var iframe = iframes[i];
      if (iframe.src && iframe.src.indexOf("tempest.services.disqus.com/ads-iframe") !== -1) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  }
  
  removeAdIframes();
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      removeAdIframes();
    });
  });
  observer.observe(disqusThread, { childList: true, subtree: true });
});
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (20)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (14)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2023/09/09/protobuf_field_merge/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/06/13/leveldb_source_LRU_cache/" title="LevelDB Explained - The Implementation Details of a High-Performance LRU Cache">LevelDB Explained - The Implementation Details of a High-Performance LRU Cache</a></li><li><a href="/en/2025/06/11/leveldb_source_memtable/" title="LevelDB Explained - The Implementation Details of MemTable">LevelDB Explained - The Implementation Details of MemTable</a></li><li><a href="/en/2025/06/10/leveldb_mvcc_intro/" title="LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)">LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)</a></li><li><a href="/en/2025/05/23/mcp_user_report/" title="In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?">In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?</a></li><li><a href="/en/2025/01/24/leveldb_source_writedb/" title="LevelDB Explained - Implementation and Optimization Details of Key-Value Writing">LevelDB Explained - Implementation and Optimization Details of Key-Value Writing</a></li><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li><li><a href="/en/2024/09/24/leveldb_source_skiplist_time_analysis/" title="LevelDB Explained - How to Analyze the Time Complexity of SkipLists?">LevelDB Explained - How to Analyze the Time Complexity of SkipLists?</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Failure-Review"><span class="toc-number">1.</span> <span class="toc-text">Failure Review</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-Reproduction"><span class="toc-number">2.</span> <span class="toc-text">Problem Reproduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#serverA"><span class="toc-number">2.1.</span> <span class="toc-text">serverA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverB"><span class="toc-number">2.2.</span> <span class="toc-text">serverB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-Code-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Source Code Analysis</span></a></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>