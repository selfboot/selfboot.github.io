<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This article documents a strange field loss issue encountered when using Protobuf in C++. Through investigation and analysis, it was found to be caused by linking different versions of Proto files. It introduces the problem reproduction, dependency analysis, symbol viewing, and other localization methods. It reminds us of the importance of consistent linking versions when using Protobuf, as inconsistencies can lead to unpredictable problems."><title>Analysis of Mysterious Field Loss When Using Protobuf in C++</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Analysis of Mysterious Field Loss When Using Protobuf in C++</h1><div class="post-meta">2023/09/07<span> | </span><span class="category"><a href="/categories/Programming/">Programming</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2023/09/07/protobuf_redefine/" href="/en/2023/09/07/protobuf_redefine/#disqus_thread"></a><div class="post-content"><p>I encountered a <strong>particularly strange</strong> problem when using Protobuf, which took a day to investigate before finally discovering the cause. This article records the process of troubleshooting and locating the problem.</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_cover.png/webp" alt="Protobuf field set and then lost" srcset="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_cover.png/webp 2162w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_cover.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_cover.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_cover.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2162" height="1088"></p>
<span id="more"></span>
<h2 id="Problem-Background"><a href="#Problem-Background" class="headerlink" title="Problem Background"></a>Problem Background</h2><p>In one of our services, there was a simple logic: set the fields in the proto protocol, then convert the pb to json, and send an HTTP request. In a recent change, we added a field called user_type to the original proto and assigned a value to this field. The change was simple, and normally, the new HTTP request’s json should have an additional user_type field in the corresponding position. However, after deploying to the test environment, we found that the new request’s json not only lacked the new field but also lost several of the original fields!</p>
<p>This seemed bizarre. We’ve been using protobuf in the project for several years and have never encountered a similar problem. Just adding an optional field and assigning a value to it, why did the old fields disappear too?</p>
<h2 id="Troubleshooting-Process"><a href="#Troubleshooting-Process" class="headerlink" title="Troubleshooting Process"></a>Troubleshooting Process</h2><p>First, we ruled out some possible points:</p>
<ol>
<li>Code logic issues: We checked the entire service code and confirmed that there was no place that would delete the set fields;</li>
<li>Inconsistent proto versions: We recompiled the code for setting fields and the pb2json part, confirming that they all used the latest proto file.</li>
</ol>
<p>Could it be that the pb2json reflection implemented in the service itself has problems? Would it lose certain fields in some special scenarios? So instead of using this function, we changed to use the DebugString function that comes with protobuf to print the content of pb, and found that there were still missing fields.</p>
<p>It’s a bit incredible. The DebugString function comes with protobuf and should be fine. The previous problem investigation required adding logs, changing the service online, which was troublesome. To narrow down the code and eliminate other interferences, <strong>quickly verify the changes</strong>, we wrote a separate tool, set the fields in the proto in the tool, and then printed them out, and the result still lost fields!</p>
<p>Thinking about the entire change again, we added a user_type field to the proto here, then set a value for this field in the code, and then the problem occurred. So what if we only change the proto here and don’t set a value for the newly added user_type field? Would there be a problem? We changed the tool and found that the fields printed out were also missing!</p>
<p><strong>Just because a field was added to the proto, some fields were missing when printed by DebugString?</strong>! This doesn’t make sense. Although our protobuf version is very old, we’ve been using it for so long and never encountered such a problem. The difference between this proto and previous protos is that it has many layers of nested messages. We haven’t had so many layers of nesting before. Could it be related to this? So we directly set the message where user_type is located, regardless of other nested messages, and the problem still persisted!</p>
<p>At this point, we started to suspect protobuf. <strong>Could it be that the old version has some bugs</strong>? We’re using version 2.6.1, which is about 10 years old. Could this special proto have triggered some mysterious bug? We searched the internet for keywords like “protobuf c++ lack field” but didn’t find any related bug descriptions.</p>
<p>It’s a bit frustrating. <strong>Reason tells me that even a low version of protobuf wouldn’t have such a low-level bug</strong>, but I really can’t find what’s wrong with my usage that would cause such strange behavior. So I threw the problem to some colleagues, after all, I’ve tried various things and really couldn’t find a clue.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Indeed, experts are around us. After reproducing the problem, a colleague immediately pointed out a key point: there’s another proto in the project that’s almost identical to this one. I also remembered that this module was actually copied from another module and underwent some changes. But the proto protocol used was still the same, just with a new field added here.</p>
<p>Intuition told me that the problem should be what my colleague discovered. To quickly verify, I changed the namespace in this new proto, then recompiled and ran it, and everything returned to normal! It seems that it was indeed because the wrong proto file was read when linking the binary, causing problems in field parsing, which led to the loss of some field values.</p>
<p>However, there are still several questions that need to be answered:</p>
<ol>
<li><strong>When was the other proto introduced?</strong></li>
<li><strong>If the two protos have the same fields and functions, why wasn’t there a link symbol redefinition error, and why was the wrong proto ultimately used?</strong></li>
<li><strong>Why does linking to another proto cause the DebugString function to read different fields?</strong></li>
</ol>
<p>With these questions in mind, let’s delve deeper. First, we need a simple reproducible code, after all, the project code is quite large, slow to compile, and has many interferences, making it troublesome to analyze. Moreover, the project code involves a lot of business information and is not suitable for public disclosure. So we need code that is completely unrelated to the current project, simple enough, and only focuses on the core problem.</p>
<h2 id="Minimal-Reproduction-Code"><a href="#Minimal-Reproduction-Code" class="headerlink" title="Minimal Reproduction Code"></a>Minimal Reproduction Code</h2><p>In practice, reproducing the problem here was simpler than imagined, requiring only a small amount of code. Mainly two proto files and one main.cpp file.</p>
<p>First is <code>modelA/data.proto</code>, which records one field, corresponding to the older proto in our project:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line">package model;</span><br><span class="line">message HWPushAndroid{</span><br><span class="line">    optional string bi_tag = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Then there’s <code>modelB/data.proto</code>, where the proto package and message name are the same as <code>modelA/data.proto</code>, but it has two additional fields, corresponding to the newer proto in the project:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line">package model;</span><br><span class="line">message HWPushAndroid{</span><br><span class="line">    optional int32 collapse_key = <span class="number">1</span> [<span class="keyword">default</span> = <span class="number">-1</span>];</span><br><span class="line">    optional string bi_tag = <span class="number">2</span>;</span><br><span class="line">    optional int32 target_user_type = <span class="number">3</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Then in <code>main.cpp</code>, we use the fields from <code>modelB/data.proto</code>, first assigning a value to each field, then printing them out:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"modelB/data.pb.h"</span>  <span class="comment">// Assume we want to use modelB's version</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    model::HWPushAndroid androidMessage;</span><br><span class="line">    androidMessage.<span class="built_in">set_collapse_key</span>(<span class="number">100</span>);    <span class="comment">// This field only exists in modelB's version</span></span><br><span class="line">    androidMessage.<span class="built_in">set_bi_tag</span>(<span class="string">"example_tag"</span>);</span><br><span class="line">    androidMessage.<span class="built_in">set_target_user_type</span>(<span class="number">1</span>);  <span class="comment">// This field only exists in modelB's version</span></span><br><span class="line">    std::cout &lt;&lt; androidMessage.<span class="built_in">DebugString</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>First, compile the proto files with protoc as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc --cpp_out=. modelA/data.proto</span><br><span class="line">protoc --cpp_out=. modelB/data.proto</span><br></pre></td></tr></tbody></table></figure>

<p>Then compile and link main as follows:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -I./ -o main ./modelA/data.pb.cc -lprotobuf</span><br></pre></td></tr></tbody></table></figure>

<p>After running, you’ll find a strange output: <code>bi_tag: "example_tag"</code>; Note that the output here is related to the version of protoc, this is the DebugString output of version <code>3.21.12</code>. In some older versions like 2.6.1, the output here may be different, or even lose certain field values.</p>
<p>We clearly set three fields, why is only one output? It’s simple, because the wrong <code>data.proto</code> was linked; the linked proto only has the <code>bi_tag</code> field, so only the value of this field is printed. In fact, this also depends on the version of protoc. In older versions, the output might be empty, or even core dump during destruction. Newer versions of protoc handle this situation better and can be compatible with such cases.</p>
<p>The correct compile and link command should be <code>g++ main.cpp -I./ -o main ./modelB/data.pb.cc -lprotobuf</code>, which would correctly output all three fields.</p>
<h2 id="Additional-Thoughts"><a href="#Additional-Thoughts" class="headerlink" title="Additional Thoughts"></a>Additional Thoughts</h2><p>We have successfully reproduced the problem here, now it’s time to answer the previous questions.</p>
<h3 id="Project-Dependency-Relationships"><a href="#Project-Dependency-Relationships" class="headerlink" title="Project Dependency Relationships"></a>Project Dependency Relationships</h3><p>The first question is, when was the other proto introduced? Our C++ project uses <a target="_blank" rel="noopener" href="https://bazel.build/?hl=zh-cn">bazel</a> for building, and the target I built <strong>theoretically</strong> shouldn’t depend on the incorrect proto in modelA. But in reality, it did depend on it. We can use query to view the dependency relationships:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bazel query 'deps(//**/**:demo_tools)' --output graph &gt; graph.in</span><br><span class="line">dot -Tpng graph.in -o graph.png</span><br></pre></td></tr></tbody></table></figure>

<p>This will output a dependency relationship graph, showing that the build target indeed depends on protos in both <code>modelA</code> and <code>modelB</code>. The reason is that the tools directly depend on a comm library, which in turn depends on <code>modelA</code>, while modelB is directly depended on by the tools.</p>
<p>Then comes the second question: <strong>Since it depends on both libraries, and there are the same functions in the proto, why didn’t the linking report duplicate symbol definitions, and why was the wrong proto ultimately used?</strong></p>
<h3 id="Link-Symbol-Resolution"><a href="#Link-Symbol-Resolution" class="headerlink" title="Link Symbol Resolution"></a>Link Symbol Resolution</h3><p>Before answering the above question, let’s go back to the reproduction code and try to compile by introducing <code>data.pb.cc</code> from both modelA and modelB at the same time, and see what happens:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -I./ -o main ./modelB/data.pb.cc ./modelA/data.pb.cc -lprotobuf</span><br></pre></td></tr></tbody></table></figure>

<p>The result is as shown in the following figure, reporting a duplicate symbol definition error:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230905_protobuf_redefine.png/webp" alt="Dependency on two modules leading to link failure" srcset="https://slefboot-1251736664.file.myqcloud.com/20230905_protobuf_redefine.png/webp 2432w, https://slefboot-1251736664.file.myqcloud.com/20230905_protobuf_redefine.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230905_protobuf_redefine.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230905_protobuf_redefine.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2432" height="786"></p>
<p>This is because <strong>the linker found two identical strong symbol definitions in the object files and couldn’t choose which one to use, so it directly reported a linking error</strong>. However, in the actual project, these two protos are in different modules, compiled into libraries first and then linked. Linking can be dynamic or static, let’s first look at the case of C++ dynamic libraries. Compile these two protos into dynamic libraries, then use dynamic linking. The specific commands are as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g++ -c -fPIC modelA/data.pb.cc -o modelA/data.pb.o -I.</span><br><span class="line">g++ -c -fPIC modelB/data.pb.cc -o modelB/data.pb.o -I.</span><br><span class="line">g++ -shared -o libmodelA.so modelA/data.pb.o</span><br><span class="line">g++ -shared -o libmodelB.so modelB/data.pb.o</span><br><span class="line">g++ main.cpp -I./ -o main -L./ -lmodelA -lmodelB -lprotobuf -Wl,-rpath,./</span><br><span class="line">g++ main.cpp -I./ -o main -L./ -lmodelB -lmodelA -lprotobuf -Wl,-rpath,./</span><br></pre></td></tr></tbody></table></figure>

<p>When linking, there are two linking orders for modelA and modelB, and the results of the binary execution are also different:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_linkorder.png/webp" alt="Different dynamic linking order, different results" srcset="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_linkorder.png/webp 1984w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_linkorder.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_linkorder.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_linkorder.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="1984" height="496"></p>
<p>What about static linking? The commands for static linking are as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g++ -c modelA/data.pb.cc -o modelA/data.pb.o -I.</span><br><span class="line">g++ -c modelB/data.pb.cc -o modelB/data.pb.o -I.</span><br><span class="line">ar rcs libmodelA.a modelA/data.pb.o</span><br><span class="line">ar rcs libmodelB.a modelB/data.pb.o</span><br><span class="line">g++ main.cpp -I./ -o main -L./  -lmodelA -lmodelB -lprotobuf</span><br><span class="line">g++ main.cpp -I./ -o main -L./  -lmodelB -lmodelA -lprotobuf</span><br></pre></td></tr></tbody></table></figure>

<p>We find that, just like dynamic linking, different linking orders result in different outcomes. From the experimental results, it appears that during linking, <strong>whether it’s dynamic or static linking, the symbol definition from the library listed earlier is actually used</strong>. This behavior is determined by the design of the linker and is not specific to static or dynamic linking. However, it’s worth noting that not all linkers will do this; this is specific to the GNU linker (commonly used on Linux), and other linkers may have different behaviors or options.</p>
<p>In the classic work <a target="_blank" rel="noopener" href="https://hansimov.gitbook.io/csapp/">Computer Systems: A Programmer’s Perspective</a>, section 7.6.3 <strong>How Linkers Use Static Libraries to Resolve References</strong> provides a detailed explanation of this.</p>
<h3 id="Which-Symbols-Were-Linked"><a href="#Which-Symbols-Were-Linked" class="headerlink" title="Which Symbols Were Linked"></a>Which Symbols Were Linked</h3><p>Now let’s answer the third question: Why does linking to another proto cause the DebugString function to read different fields?</p>
<p>Through the above experiments, we know that due to incorrect linking order, the fields read by protobuf’s <code>DebugString</code> are different. So which symbol resolutions are wrong, causing incorrect output? We can use the <code>objdump</code> command to check the symbols in the binary. Let’s first look at the DebugString symbol, with the specific command as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">objdump -tT  main | grep DebugString</span></span><br><span class="line">0000000000000000       F *UND*	0000000000000000              _ZNK6google8protobuf7Message11DebugStringB5cxx11Ev</span><br><span class="line">0000000000000000      DF *UND*	0000000000000000  Base        _ZNK6google8protobuf7Message11DebugStringB5cxx11Ev</span><br></pre></td></tr></tbody></table></figure>

<p>In the binary files generated with different linking orders, the DebugString function is marked as <code>UND</code> (undefined), which means this function is not defined in the current binary file but is loaded from some dynamic library at runtime. We can use ldd to find the address of the protobuf dynamic library that the binary depends on, and then use readelf to verify that it’s indeed in the libprotobuf dynamic library:</p>
<figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ldd mainA</span><br><span class="line">	linux-vdso.<span class="keyword">so</span>.<span class="number">1</span> (<span class="number">0</span>x00007ffe53b86000)</span><br><span class="line">	libprotobuf.<span class="keyword">so</span>.<span class="number">32</span> =&gt; /lib/x86_64-linux-gnu/libprotobuf.<span class="keyword">so</span>.<span class="number">32</span> (<span class="number">0</span>x00007f6682359000)</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">nm</span> -D /lib/x86_64-linux-gnu/libprotobuf.<span class="keyword">so</span>.<span class="number">32</span> | <span class="keyword">grep</span> DebugString</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p>The implementation of <code>DebugString</code> is in <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/text_format.cc#L131">protobuf/src/google/protobuf/text_format.cc</a>, which uses a <strong>reflection mechanism</strong> and is quite complex. I haven’t fully understood it yet, and when I have time, I can continue to study it and organize a dedicated article. Here we just want to know why <code>target_user_type</code> wasn’t output, so let’s try filtering this symbol and see if there’s any difference in the binaries with different orders, as shown in the following figure:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_sysbol.png/webp" alt="Different dynamic linking order, different results" srcset="https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_sysbol.png/webp 2434w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_sysbol.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_sysbol.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20230906_protobuf_redefine_sysbol.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2434" height="544"></p>
<p>We can see that under both linking orders, there are symbols from modelB like <code>set_target_user_type</code>, corresponding to two functions:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZN5model13HWPushAndroid20set_target_user_typeEi</span></span><br><span class="line">model::HWPushAndroid::set_target_user_type(int)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZN5model13HWPushAndroid30_internal_set_target_user_typeEi</span></span><br><span class="line">model::HWPushAndroid::_internal_set_target_user_type(int)</span><br></pre></td></tr></tbody></table></figure>

<p>This is as expected because main calls this function to set it, and modelA doesn’t have this field, so regardless of the order, it will link to modelB’s symbol implementation. However, when modelA is in front, the following symbols are missing:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZN5model13HWPushAndroid9_Internal24set_has_target_user_typeEPN6google8protobuf8internal7HasBitsILm1EEE</span></span><br><span class="line">model::HWPushAndroid::_Internal::set_has_target_user_type(google::protobuf::internal::HasBits&lt;1ul&gt;*)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZNK5model13HWPushAndroid26_internal_target_user_typeEv</span></span><br><span class="line">model::HWPushAndroid::_internal_target_user_type() const</span><br></pre></td></tr></tbody></table></figure>

<p>For protobuf, all the metadata of this type, including all fields, nested types, etc., are associated with the generated message type. This allows for very rich reflection operations at runtime, including but not limited to finding fields, dynamically creating messages, dynamically setting and getting field values, etc. Here, linking the pb from modelA first causes the message type in the proto to not be associated with the target_user_type field, so the functions <code>_internal_target_user_type()</code> and <code>set_has_target_user_type</code> are not used, hence these two symbols are not in the binary.</p>
<p>Going a step further, what happens if I directly access the target_user_type field in main.cpp? The code is as follows:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">std::cout &lt;&lt; androidMessage.<span class="built_in">target_user_type</span>() &lt;&lt; std::endl;</span><br><span class="line">std::cout &lt;&lt; androidMessage.<span class="built_in">DebugString</span>() &lt;&lt; std::endl;</span><br></pre></td></tr></tbody></table></figure>

<p>We can see that the output of DebugString is still related to the linking order, but regardless of the order, directly outputting target_user_type is possible. This time, because the target_user_type() function is directly used, both binaries have the following symbols:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZNK5model13HWPushAndroid16target_user_typeEv</span></span><br><span class="line">model::HWPushAndroid::target_user_type() const</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">c++filt _ZNK5model13HWPushAndroid26_internal_target_user_typeEv</span></span><br><span class="line">model::HWPushAndroid::_internal_target_user_type() const</span><br></pre></td></tr></tbody></table></figure>

<p>At this point, the three questions in the article have been resolved. When using protobuf, we must pay attention to <strong>whether the linked proto implementation is correct</strong>. If there are duplicate fields in multiple protos, we can use namespaces to distinguish them, which will avoid the linking error problem in this article.</p>
<p>During the troubleshooting process of this problem, it really felt like “seeing a ghost”. Even with simple and common usage, there can be such unexpected behavior. Through various exclusion methods of debugging, we couldn’t locate the problem at all, giving a sense of helplessness like hitting a “ghost wall”. Thankfully, with the hints from colleagues, we were able to clear the fog and finally locate the problem. And through reproduction, we further understood the reasons behind it.</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/C/"><i class="fa fa-tag"></i>C++</a><a href="/tags/Debug/"><i class="fa fa-tag"></i>Debug</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2023/09/07/protobuf_redefine/';
    this.page.identifier = 'en/2023/09/07/protobuf_redefine/';
    this.page.title = 'Analysis of Mysterious Field Loss When Using Protobuf in C++';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (16)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (13)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2023/09/07/protobuf_redefine/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li><li><a href="/en/2024/09/24/leveldb_source_skiplist_time_analysis/" title="LevelDB Explained - How to Analyze the Time Complexity of SkipLists?">LevelDB Explained - How to Analyze the Time Complexity of SkipLists?</a></li><li><a href="/en/2024/09/18/leveldb_source_skiplist_test/" title="LevelDB Explained - How to Test Parallel Read and Write of SkipLists?">LevelDB Explained - How to Test Parallel Read and Write of SkipLists?</a></li><li><a href="/en/2024/09/13/gpto1_hands_on/" title="Hands-on with OpenAI's o1-preview - Not Better Enough?">Hands-on with OpenAI's o1-preview - Not Better Enough?</a></li><li><a href="/en/2024/09/09/leveldb_source_skiplist/" title="LevelDB Explained - How to implement SkipList">LevelDB Explained - How to implement SkipList</a></li><li><a href="/en/2024/09/05/claude35_prompt/" title="Claude3.5's System Prompts - No Apologies, Face Blind, Hallucinate...">Claude3.5's System Prompts - No Apologies, Face Blind, Hallucinate...</a></li><li><a href="/en/2024/08/29/leveldb_source_utils/" title="LevelDB Explained - Arena, Random, CRC32, and More.">LevelDB Explained - Arena, Random, CRC32, and More.</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-Background"><span class="toc-number">1.</span> <span class="toc-text">Problem Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Troubleshooting-Process"><span class="toc-number">2.</span> <span class="toc-text">Troubleshooting Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution"><span class="toc-number">3.</span> <span class="toc-text">Solution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Minimal-Reproduction-Code"><span class="toc-number">4.</span> <span class="toc-text">Minimal Reproduction Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Additional-Thoughts"><span class="toc-number">5.</span> <span class="toc-text">Additional Thoughts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Project-Dependency-Relationships"><span class="toc-number">5.1.</span> <span class="toc-text">Project Dependency Relationships</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Link-Symbol-Resolution"><span class="toc-number">5.2.</span> <span class="toc-text">Link Symbol Resolution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Which-Symbols-Were-Linked"><span class="toc-number">5.3.</span> <span class="toc-text">Which Symbols Were Linked</span></a></li></ol></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>