<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This article first reproduces the coredump issue in business operations, then investigates the C++ object memory layout using GDB, revealing memory errors caused by mixing different versions of protobuf files due to incomplete Bazel dependency management. It also introduces link symbol resolution and Bazel dependency management."><title>Analysis of Coredump Caused by Missing Bazel Dependencies</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924" data-domains="selfboot.cn"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Analysis of Coredump Caused by Missing Bazel Dependencies</h1><div class="post-meta">2024/03/15<span> | </span><span class="category"><a href="/categories/Programming/">Programming</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2024/03/15/object_memory_coredump/" href="/en/2024/03/15/object_memory_coredump/#disqus_thread"></a><div class="post-content"><p>Recently, I encountered a strange coredump problem in a project, and the troubleshooting process was not smooth. After continuous analysis, I found a reproducible step, and through reasonable guessing and careful verification, I finally located the cause.</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20231123_object_memory_coredump_cover.png/webp" alt="C++ coredump Bazel dependency missing" srcset="https://slefboot-1251736664.file.myqcloud.com/20231123_object_memory_coredump_cover.png/webp 1848w, https://slefboot-1251736664.file.myqcloud.com/20231123_object_memory_coredump_cover.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20231123_object_memory_coredump_cover.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20231123_object_memory_coredump_cover.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="1848" height="1202"></p>
<p>Looking back, I found that this type of coredump problem is indeed rare and not easy to troubleshoot. It’s only possible when the <strong>project code compilation dependency management is not very reasonable</strong>. Additionally, during the review process, I gained a better understanding of the coredump and <strong>C++ object memory distribution</strong> here. So I’ve organized an article, and if there are any errors, please feel free to point them out.</p>
<span id="more"></span>

<h2 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><p>First, let’s talk about the basic architecture of the backend service. The outermost layer is the CGI layer handling HTTP requests forwarded by Nginx, and then the specific business is processed in the middle logic layer. The logic layer is a microservice framework, with different services communicating through RPC calls, using something similar to <a target="_blank" rel="noopener" href="https://grpc.io/">grpc</a>.</p>
<p>In a certain change, a field was added to an RPC request parameter (for example, age below) in the <code>service.proto</code> file of service A:</p>
<figure class="highlight proto"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> {</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>{}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> {</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> age = <span class="number">2</span>;   <span class="comment">// Added parameter</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> {</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Then, the related logic for this field was added, and subsequently, the module was compiled and deployed. We know that in microservice architecture, it’s common for <strong>multiple services to share the same proto object</strong>. If you need to modify the proto, it’s generally done by <strong>adding fields</strong>, which is compatible with both the caller and the callee. After service A is deployed with the new proto, other services using this proto will use the old version until they are recompiled, which shouldn’t cause problems. Strictly speaking, this can potentially cause issues, which I’ve encountered before, mainly related to Merge compatibility problems. You can refer to my previous article <a href="https://selfboot.cn/en/2023/09/09/protobuf_field_merge/">Analysis of Storage Failure Caused by Protobuf Serialized Messages</a>.</p>
<p>Normally, if other services want to update the proto, they just need to recompile to use the new proto, which shouldn’t cause any problems. However, this time there was an issue: <strong>after service A’s proto added a field and was deployed, other services calling A through the client would coredump as soon as they were recompiled and deployed</strong>.</p>
<h2 id="Reproduction-Steps"><a href="#Reproduction-Steps" class="headerlink" title="Reproduction Steps"></a>Reproduction Steps</h2><p>After looking at the core file from the production environment, I didn’t find particularly useful information (my skills in locating problems through core files are still not sufficient). So I thought about trying to reproduce it stably first, after all, for core problems, if you can reproduce them stably, the problem is basically half solved. Fortunately, after some attempts, I found a step that could stably reproduce the issue.</p>
<h3 id="Old-Version-Proto"><a href="#Old-Version-Proto" class="headerlink" title="Old Version Proto"></a>Old Version Proto</h3><p>Create an initial version of the proto file, let’s call it data.proto, and compile it with protoc to <code>data.pb.h</code> and <code>data.pb.cc</code>. The content of the proto file is as follows:</p>
<figure class="highlight proto"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> example;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">Data</span> {</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The compilation command is simple, just <code>protoc --cpp_out=. data.proto</code>. In addition, there’s a libdata.cpp file that defines a processData function using the above proto object. This cpp file is compiled into a public library <code>libdata.so</code>:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libdata.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"data.pb.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> example::Data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">processData</span><span class="params">(Data &amp;req)</span> </span>{</span><br><span class="line">    Data data;</span><br><span class="line">    data.<span class="built_in">set_message</span>(<span class="string">"Hello from lib"</span>);</span><br><span class="line">    std::cout&lt;&lt; <span class="string">"In lib, data size: "</span> &lt;&lt; <span class="built_in">sizeof</span>(data)&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt; <span class="string">"In lib, data  msg: "</span> &lt;&lt; data.<span class="built_in">message</span>()&lt;&lt;std::endl;</span><br><span class="line"></span><br><span class="line">    std::cout&lt;&lt; <span class="string">"In lib, req size: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req)&lt;&lt;std::endl;</span><br><span class="line">    std::cout&lt;&lt; <span class="string">"In lib, req  msg: "</span> &lt;&lt; req.<span class="built_in">message</span>()&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The command to compile it into a dynamic library is as follows:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -fPIC -shared libdata.cpp data.pb.cc -o libdata.so -lprotobuf -g</span><br></pre></td></tr></tbody></table></figure>

<p>Now we have the <code>libdata.so</code> dynamic library file.</p>
<h3 id="Updating-Proto"><a href="#Updating-Proto" class="headerlink" title="Updating Proto"></a>Updating Proto</h3><p>Next, let’s modify the data.proto file and add a <strong>repeated field</strong>, as follows:</p>
<figure class="highlight proto"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> example;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">Data</span> {</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="type">int32</span> users = <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Then recompile the proto file with protoc</strong>. Next, write our main program, let’s call it <code>main.cpp</code>, which simply calls the function in the <code>libdata.so</code> library. The content is as follows:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"data.pb.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> example::Data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">void</span> <span class="title">processData</span><span class="params">(Data&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    Data req;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    req.<span class="built_in">set_message</span>(<span class="string">"test"</span>);</span><br><span class="line">    <span class="built_in">processData</span>(req);  <span class="comment">// Call library function</span></span><br><span class="line">    std::cout &lt;&lt; req.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Then compile and link our main program with the following command:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -o main -L. -lprotobuf -Wl,-rpath,. -ldata -g</span><br></pre></td></tr></tbody></table></figure>

<p>Note that our <code>libdata.so</code> library file is in the current directory, so we need to use <code>-Wl,-rpath,.</code> to specify the search path for dynamic libraries. Then run the program, and it will reproduce the coredump, as shown in the following figure:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240131_object_memory_coredump_reproduced.png/webp" alt="Successfully reproduced coredump" srcset="https://slefboot-1251736664.file.myqcloud.com/20240131_object_memory_coredump_reproduced.png/webp 2032w, https://slefboot-1251736664.file.myqcloud.com/20240131_object_memory_coredump_reproduced.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240131_object_memory_coredump_reproduced.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240131_object_memory_coredump_reproduced.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2032" height="596"></p>
<h2 id="In-depth-Analysis"><a href="#In-depth-Analysis" class="headerlink" title="In-depth Analysis"></a>In-depth Analysis</h2><p>Most of the time, if you can stably reproduce a coredump, it’s basically easy to find the cause of the coredump. Compile with <code>-g</code> to include debugging information, and then you can use gdb to trace and investigate. Since it will core dump at <code>set_message</code>, we can set a breakpoint here, first check the memory layout of the req object, then execute until the core dump, and check the stack. The overall result is as follows:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_message.png/webp" alt="GDB view of coredump memory layout" srcset="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_message.png/webp 2130w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_message.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_message.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_message.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2130" height="1582"></p>
<p>First, use GDB to print the contents of req. <strong>Strangely, there’s only the message field here, and the users field is not visible</strong>. Then execute to <code>req.set_message("test");</code>. From the coredump stack, we can see that the this and value addresses in set_message are fine. But when <code>ArenaStringPtr::Set</code> is called at the bottom, the this address is <code>0x7fffffffe3a8</code>, which seems to be the address of the message field. From the previous output, it should be <code>0x7fffffffe390</code> (not sure about this, we’ll verify it later).</p>
<figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">....</span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>x000055<span class="number">55555564e6</span> in googl<span class="number">e::</span>protobu<span class="number">f::</span>internal<span class="number">::</span>ArenaStringPtr<span class="number">::</span>Set (this=<span class="number">0</span>x7fffffffe3a8,</span><br><span class="line">    default_value=<span class="number">0</span>x<span class="number">555555559100</span> &lt;googl<span class="number">e::</span>protobu<span class="number">f::</span>internal<span class="number">::</span>fixed_address_empty_string[abi:cxx11]&gt;,</span><br><span class="line">    value="test", arena=<span class="number">0</span>x0) at /usr/include/google/protobuf/arenastring.h:<span class="number">81</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>x00005<span class="number">55555556948</span> in exampl<span class="number">e::</span>Dat<span class="number">a::</span>set_message (this=<span class="number">0</span>x7fffffffe380, value=<span class="number">0</span>x55<span class="number">55555570f0</span> "test")</span><br><span class="line">    at data.pb.h:<span class="number">288</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>x00005<span class="number">55555556312</span> in main () at main.cpp:<span class="number">12</span></span><br></pre></td></tr></tbody></table></figure>

<p>The direct cause of the coredump is that the memory address of the message field is incorrect. So what caused the memory address to be wrong? Here we need to review our compilation and running process. We know that in C++, <strong>the memory layout of objects is determined by the definition of their class</strong>, which is usually given in the header file (.h). When compiling a C++ program, the compiler determines the size and memory layout of each object based on the class definition (including the type, number, order of member variables, etc.). Specifically for the C++ classes generated by Protobuf here, the class definitions are usually contained in the .pb.h file, while the .pb.cc file contains the implementations of the methods of these classes, including field accessors (such as set_message and message) and implementations of other member functions. These implementations are responsible for <strong>actual data operations, such as allocating memory, modifying field values, generating string representations of objects</strong>, etc.</p>
<h3 id="Object-Memory-Distribution"><a href="#Object-Memory-Distribution" class="headerlink" title="Object Memory Distribution"></a>Object Memory Distribution</h3><p>In our compilation process above, the main program <code>main.cpp</code> uses the new version of <code>data.pb.h</code>, so the Data object in main is compiled <strong>according to the new memory layout</strong>. The memory layout of the object here includes the arrangement of member variables, the total size of the object, and possible padding (to meet alignment requirements), so <strong>the Data object in main includes the users field</strong>. How do we verify this? It’s simple, we can print the size of the Data object in main, as follows, first <strong>comment out the set_message and code that reads message which would cause coredump</strong>:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"data.pb.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> example::Data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">void</span> <span class="title">processData</span><span class="params">(Data&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    Data req;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// req.set_message("test");</span></span><br><span class="line">    <span class="built_in">processData</span>(req);  <span class="comment">// Call library function</span></span><br><span class="line">    <span class="comment">// std::cout &lt;&lt; req.message() &lt;&lt; std::endl;</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Then recompile and link, run the program, the output is as follows:</p>
<figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">main:</span> <span class="number">56</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">lib</span>, data size: <span class="number">32</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">lib</span>, data  msg: Hello <span class="keyword">from</span> <span class="keyword">lib</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">lib</span>, req size: <span class="number">32</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">lib</span>, req  msg:</span><br><span class="line"><span class="symbol">main:</span> <span class="number">56</span></span><br></pre></td></tr></tbody></table></figure>

<p>We can see that <strong>the size of data in main is 56, while the size of data in lib is 32</strong>. Through this verification, we can confirm that the Data object in main includes the users field, so it will be larger than the Data object in lib.</p>
<p>Since it includes the users field, why <strong>when gdb prints the req object in main.cpp, it doesn’t include the users field</strong>? We know that GDB can output object members, local variables and other information because it uses the <strong>symbol table information</strong> in the binary file. The <code>-g</code> option in gcc compilation will include this debugging information. For pb objects, this debugging information is in the <code>.pb.cc</code> file, including logic on how to serialize and deserialize fields, how to manage memory (including handling dynamically allocated fields such as strings and repeated fields), etc.</p>
<p>If we carefully review the compilation and linking command for main earlier, we actually linked to the old data.pb.cc implementation in the dynamic library libdata.so, and this version of the implementation doesn’t have the users field. So when gdb prints, it can’t display it.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -o main -L. -lprotobuf -Wl,-rpath,. -ldata -g</span><br></pre></td></tr></tbody></table></figure>

<p>Actually, there’s another question that needs to be explained here: why didn’t the program core dump when we commented out the set_message and code that reads message earlier? This is because the main program no longer attempts to modify or access the contents of the req object. Although the memory layout of the req object doesn’t match that in libdata.so, since there’s no actual operation on these inconsistent memory areas, it doesn’t trigger illegal memory access.</p>
<h3 id="Linking-New-Version-PB"><a href="#Linking-New-Version-PB" class="headerlink" title="Linking New Version PB"></a>Linking New Version PB</h3><p>Earlier, when we linked main, we used the old <code>data.pb.cc</code> in the dynamic library. What if we change to link the new <code>data.pb.cc</code>? Will the program still core dump? Let’s slightly modify the previous compilation and linking command, note that the set_message part in main.cpp is still commented out:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp data.pb.cc  -o main -L. -lprotobuf -Wl,-rpath,. -ldata -g</span><br></pre></td></tr></tbody></table></figure>

<p>The new linking command only needs to put <code>data.pb.cc</code> before <code>-ldata</code> to link to the new pb implementation. For the process of link symbol resolution here, you can refer to my previous article <a href="https://selfboot.cn/en/2023/09/19/c++_symbol_resolution/">Deep Understanding of C++ Link Symbol Resolution: Starting from Symbol Redefinition</a>.</p>
<p>After compiling and running the program, we found that it indeed core dumped again, but this time the core dump location is in the <code>processData</code> function in <code>libdata.cpp</code>, specifically at <code>data.set_message("Hello from lib");</code>, as shown in the following figure:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240314_object_memory_coredump_core_inlib.png/webp" alt="Continue to coredump after changing link order" srcset="https://slefboot-1251736664.file.myqcloud.com/20240314_object_memory_coredump_core_inlib.png/webp 2130w, https://slefboot-1251736664.file.myqcloud.com/20240314_object_memory_coredump_core_inlib.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240314_object_memory_coredump_core_inlib.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240314_object_memory_coredump_core_inlib.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2130" height="1036"></p>
<p>This is because the Data object definition in our <code>libdata.so</code> uses the old <code>data.pb.h</code>, while the implementation linked to is the new <code>data.pb.cc</code>, causing object inconsistency, so memory will be scrambled leading to core dump.</p>
<p>The <strong>location of the core dump here is also quite interesting</strong>. If we don’t comment out the set_message part in main.cpp, like this:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    Data req;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    req.<span class="built_in">set_message</span>(<span class="string">"test"</span>);    <span class="comment">// Don't comment this out</span></span><br><span class="line">    <span class="built_in">processData</span>(req);  <span class="comment">// Call library function</span></span><br><span class="line">    std::cout &lt;&lt; req.<span class="built_in">message</span>() &lt;&lt; std::endl; <span class="comment">// Don't comment this out</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>The program didn’t core dump in the processData of the dynamic library, but instead core dumped at <code>req.message()</code> in main. This is probably because the object access in processData <strong>coincidentally</strong> didn’t scramble, until accessing <code>req.message()</code> in main triggered the memory error. So what if we also comment out the <code>req.message()</code> line? Will the following code still core dump?</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    Data req;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    req.<span class="built_in">set_message</span>(<span class="string">"test"</span>);    <span class="comment">// Don't comment this out</span></span><br><span class="line">    <span class="built_in">processData</span>(req);  <span class="comment">// Call library function</span></span><br><span class="line">    <span class="comment">// std::cout &lt;&lt; req.message() &lt;&lt; std::endl; // Comment this out!!!</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"main: "</span> &lt;&lt; <span class="built_in">sizeof</span>(req) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>After execution, we found that the program ran to return, printed all the content, but still core dumped at the end. The output is as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">g++ main.cpp data.pb.cc  -o main -L. -lprotobuf -Wl,-rpath,. -ldata -g</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./main</span></span><br><span class="line">main: 56</span><br><span class="line">In lib, data size: 32</span><br><span class="line">In lib, data  msg: Hello from lib</span><br><span class="line">In lib, req size: 32</span><br><span class="line">In lib, req  msg: test</span><br><span class="line">main: 56</span><br><span class="line">[1]    1302869 segmentation fault  ./main</span><br></pre></td></tr></tbody></table></figure>

<p>The specific core dump location is in the destruction process of the req object in main. Through GDB, we can find that before processData processing, printing req can also see the user field. But after processData, the <strong>memory address of req directly becomes an invalid address</strong>, so the subsequent destruction fails. The overall GDB process is as follows:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_core_destroy.png/webp" alt="Core dumped in the destructor" srcset="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_core_destroy.png/webp 2116w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_core_destroy.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_core_destroy.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_core_destroy.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2116" height="1626"></p>
<p>To add a bit more here, actually when processing req in processData, because there are two versions of the definition and implementation of the Data object, it causes the memory address of req to be scrambled. It’s just a <strong>coincidence</strong> that the operations in this function didn’t core dump due to memory issues, until the destruction in main finally triggered the core dump.</p>
<h2 id="Memory-Analysis-in-Normal-Situations"><a href="#Memory-Analysis-in-Normal-Situations" class="headerlink" title="Memory Analysis in Normal Situations"></a>Memory Analysis in Normal Situations</h2><p>The root cause of the program’s core dump above is that <strong>different versions of data.pb.h and data.pb.cc were used in one executable file, leading to abnormal memory reading and writing</strong>. Next, let’s look at how the memory distribution of pb objects is in the entire process under normal circumstances. At the same time, let’s verify a guess we left earlier: when <code>ArenaStringPtr::Set</code> is called at the bottom layer, the this address is <code>0x7fffffffe3a8</code>, which is the address of the message field.</p>
<p>First, regenerate the dynamic library using the new version of data.pb.cc, then recompile the main program. The running result is as follows, everything is normal.</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./main</span><br><span class="line">main: 56</span><br><span class="line">In lib, data size: 56</span><br><span class="line">In lib, data  msg: Hello from lib</span><br><span class="line">In lib, req size: 56</span><br><span class="line">In lib, req  msg: test</span><br><span class="line">main: 56</span><br></pre></td></tr></tbody></table></figure>

<p>Then let’s analyze it using GDB. We can print the req object, which contains the users and message fields. Get the address of message, and we can see that it’s the same as the this address in the subsequent <code>ArenaStringPtr::Set</code>. Moreover, after being processed by processData, the memory address of the req object here hasn’t changed, indicating that the memory operation here is normal. The overall GDB process is as follows:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_normal.png/webp" alt="GDB memory view in normal situations" srcset="https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_normal.png/webp 2130w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_normal.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_normal.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240315_object_memory_coredump_gdb_normal.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2130" height="1716"></p>
<h2 id="Bazel-Dependency-Missing"><a href="#Bazel-Dependency-Missing" class="headerlink" title="Bazel Dependency Missing"></a>Bazel Dependency Missing</h2><p>Let’s return to the business background introduced at the beginning of the article. The C++ project in the business has many dependencies and uses Bazel for dependency management. The problematic BUILD file is roughly as follows:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">proto_library(</span><br><span class="line">    name = "data_proto",</span><br><span class="line">    srcs = ["data.proto"],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_proto_library(</span><br><span class="line">    name = "data_cc_proto",</span><br><span class="line">    deps = [":data_proto"],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_library(</span><br><span class="line">    name = "libdata",</span><br><span class="line">    srcs = ["libdata.cpp"],</span><br><span class="line">    includes = ["."],         # Root of all evil</span><br><span class="line"></span><br><span class="line">    # deps = [":data_cc_proto"], # Missed this crucial dependency</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_binary(</span><br><span class="line">    name = "main",</span><br><span class="line">    srcs = ["main.cpp"],</span><br><span class="line">    deps = [":libdata", ":data_cc_proto"],</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>The dependency of libdata here is actually incomplete. Normally, it should depend on data_cc_proto, but it doesn’t here. After updating data.proto, when recompiling main, <strong>Bazel analyzes the dependency relationship and finds that data.proto is not used in the declared dependencies (although it’s actually depended on), so it won’t recompile libdata</strong>. This causes the Data object definition in libdata to still be the old version, while the Data object in main will use the new version, leading to memory scrambling as before, and ultimately causing a coredump.</p>
<p>In fact, for libdata to compile successfully, it needs to find the <code>data.pb.h</code> header file. Here, the <code>includes = ["."]</code> approach is used, which allows a rule and all its transitive dependencies to include header files from any location within the workspace. This approach has many problems, such as reducing the encapsulation and maintainability of the library and slowing down the build speed. <strong>The latest version of Bazel has actually prohibited this approach</strong>, and it’s not recommended in older versions of Bazel either.</p>
<p>In our project, because we need to be compatible with a relatively old version of protobuf (around version 2.6, which is also very old), <strong>we’re using an old version of Bazel</strong>, roughly the 2017 version. In the BUILD file, <code>include=['.']</code> is also widely used, causing the dependency paths of header files to be very messy. So although the lib library’s dependency relationship is incomplete, it can still compile, laying the groundwork for subsequent coredumps. If upgraded to a new version of Bazel, the dependency management would be stricter, making it easier to discover such missing dependency BUILD writings.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Finally, let’s summarize briefly. The problem started with simply adding a field to the proto, unexpectedly leading to a coredump. Although we knew it was related to the field addition change, it still took a lot of time to analyze the specific cause.</p>
<p>Many troubleshooting directions were attempted in the process:</p>
<ol>
<li>Is there a bug in the protobuf library? Searched around but didn’t find similar issues, and it has been very stable after using it for so long, so this possibility was ruled out first.</li>
<li>Analyzed the coredump file but didn’t find useful information. On one hand, this was because I’m not very familiar with the implementation of protobuf, so I didn’t know where to start when it core dumped in pb. On the other hand, my skills in analyzing cores with GDB are not very deep.</li>
<li>Continuously <strong>stripped away irrelevant logic</strong>, trying to find a small demo that could reproduce the issue. Here, a colleague finally found a reproducible step, which became the breakthrough. After the colleague stably reproduced it, it became relatively easy to guess and verify that it was related to using different versions of the proto.</li>
</ol>
<p>Then, thinking about writing an article to record this uncommon pitfall, I encountered another problem when preparing the code for the article review. When my colleague reproduced it earlier, there was actually a lot of project code logic involved, and the Bazel dependency relationships were quite complex. In the article, I wanted to use the <strong>simplest code</strong> to reproduce and explain the problem. At first, when simulating the proto modification, I only added a string field, but found that it didn’t cause a coredump. Although the memory layout of the Data object was different here, it <strong>coincidentally</strong> read and wrote memory normally, not triggering illegal memory access. Later, I thought about increasing the “disturbance” here and tried switching to repeated, which could stably reproduce the coredump.</p>
<p>One advantage of having sufficiently simple review code is that it’s also convenient to debug with GDB, without too much irrelevant information. By comparing the changes in object memory addresses in core and normal code, it once again verified that the core was indeed caused by using different versions of pb objects. However, this article still lacks some depth, <strong>not going into a deep analysis of why different versions of pb would cause address scrambling</strong>, which probably requires delving into the implementation of protobuf.</p>
<p>The last question is, how to avoid such problems in the project in the future? First, avoid using <code>include ['.']</code> which brings chaotic header file search paths, then <strong>standardize dependency management</strong>, adding dependencies on pb for all libraries that use protobuf. Of course, it would be best to upgrade Bazel if possible, but this would require more manpower.</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/C/"><i class="fa fa-tag"></i>C++</a><a href="/tags/Debug/"><i class="fa fa-tag"></i>Debug</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2024/03/15/object_memory_coredump/';
    this.page.identifier = 'en/2024/03/15/object_memory_coredump/';
    this.page.title = 'Analysis of Coredump Caused by Missing Bazel Dependencies';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });</script></div><script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
  var disqusThread = document.getElementById('disqus_thread');
  if (!disqusThread) return;
  
  function removeAdIframes() {
    var iframes = disqusThread.getElementsByTagName('iframe');
    for (var i = iframes.length - 1; i >= 0; i--) {
      var iframe = iframes[i];
      if (iframe.src && iframe.src.indexOf("tempest.services.disqus.com/ads-iframe") !== -1) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  }
  
  removeAdIframes();
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      removeAdIframes();
    });
  });
  observer.observe(disqusThread, { childList: true, subtree: true });
});
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget recommendations-widget"><div class="widget-title"> Recommended</div><div class="recommendations-container"><div class="recommendation-item"><a class="promo-link" href="https://puzzles-game.com/" target="_blank"><div class="promo-content"><i class="fa fa-gamepad"></i><span class="promo-text">Train Your Brain And Stay Smart</span></div></a></div><div class="recommendation-item"><a class="promo-link" href="https://gallery.selfboot.cn" target="_blank"><div class="promo-content"><i class="fa fa-robot"></i><span class="promo-text">Use AI And Help Me Make Things</span></div></a></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (21)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (14)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2024/03/15/object_memory_coredump/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/06/27/leveldb_source_table_build/" title="LevelDB Explained - A Step by Step Guide to SSTable Build">LevelDB Explained - A Step by Step Guide to SSTable Build</a></li><li><a href="/en/2025/06/13/leveldb_source_LRU_cache/" title="LevelDB Explained - The Implementation Details of a High-Performance LRU Cache">LevelDB Explained - The Implementation Details of a High-Performance LRU Cache</a></li><li><a href="/en/2025/06/11/leveldb_source_memtable/" title="LevelDB Explained - The Implementation Details of MemTable">LevelDB Explained - The Implementation Details of MemTable</a></li><li><a href="/en/2025/06/10/leveldb_mvcc_intro/" title="LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)">LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)</a></li><li><a href="/en/2025/05/23/mcp_user_report/" title="In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?">In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?</a></li><li><a href="/en/2025/01/24/leveldb_source_writedb/" title="LevelDB Explained - Implementation and Optimization Details of Key-Value Writing">LevelDB Explained - Implementation and Optimization Details of Key-Value Writing</a></li><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-Description"><span class="toc-number">1.</span> <span class="toc-text">Problem Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reproduction-Steps"><span class="toc-number">2.</span> <span class="toc-text">Reproduction Steps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Old-Version-Proto"><span class="toc-number">2.1.</span> <span class="toc-text">Old Version Proto</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Updating-Proto"><span class="toc-number">2.2.</span> <span class="toc-text">Updating Proto</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#In-depth-Analysis"><span class="toc-number">3.</span> <span class="toc-text">In-depth Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-Memory-Distribution"><span class="toc-number">3.1.</span> <span class="toc-text">Object Memory Distribution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linking-New-Version-PB"><span class="toc-number">3.2.</span> <span class="toc-text">Linking New Version PB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Analysis-in-Normal-Situations"><span class="toc-number">4.</span> <span class="toc-text">Memory Analysis in Normal Situations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bazel-Dependency-Missing"><span class="toc-number">5.</span> <span class="toc-text">Bazel Dependency Missing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p><p>Friend Link:<a rel="dofollow" target="_blank" href="https://puzzles-game.com/">Puzzle Games</a></p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><link rel="stylesheet" type="text/css" href="/css/recommendations.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>