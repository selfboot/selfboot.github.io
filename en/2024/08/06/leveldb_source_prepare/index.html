<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This article introduces how to prepare the development environment for LevelDB, including source code retrieval, compilation, and VSCode configuration. Through simple read and write examples, readers can gain a preliminary understanding of LevelDB. The article also explains how to use the gtest framework to run and modify test cases for better understanding of the code logic."><title>LevelDB Explained - Preparing the Development Environment</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924" data-domains="selfboot.cn"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}
</script><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7746897490519544" crossorigin="anonymous"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">LevelDB Explained - Preparing the Development Environment</h1><div class="post-meta">2024/08/06<span> | </span><span class="category"><a href="/categories/Source-Code-Analysis/">Source Code Analysis</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2024/08/06/leveldb_source_prepare/" href="/en/2024/08/06/leveldb_source_prepare/#disqus_thread"></a><div class="post-content"><p>LevelDB is an excellent LSM Tree storage component developed in C++. Although its overall codebase is not large, its design is ingenious and worth studying. During the process of reading the source code, I have compiled a <a href="https://selfboot.cn/en/tags/LevelDB/">series of articles</a> to gradually break down the implementation details of LevelDB. However, before reading the code, it’s best to prepare the entire development environment.</p>
<p>This article will start from the most basic step of pulling the code, recording my process of preparing the entire environment, including configuring the VSCode IDE and using the clangd plugin, as well as how to configure compilation options. Then, through a simple read and write code demo, we’ll briefly use LevelDB to gain a perceptual understanding of this library. Additionally, we’ll introduce how to run test cases. LevelDB’s test cases are well-written, and during the code reading process, we can use these cases to better understand the code.</p>
<span id="more"></span>

<h2 id="Source-Code-Compilation"><a href="#Source-Code-Compilation" class="headerlink" title="Source Code Compilation"></a>Source Code Compilation</h2><p>First is pulling the code. Here we use <code>git clone --recurse-submodules</code>, which can pull all submodules at once. Although LevelDB’s implementation doesn’t depend on third-party libraries, benchmark is used for pressure testing and googletest is used for functional testing, both of which are introduced as submodules.</p>
<p>If you encounter network issues when pulling the code, such as the following, you need to bypass the firewall first. You can refer to the methods in the article <a href="https://selfboot.cn/2023/12/25/how-to-use-chatgpt/">Safe, Fast, and Affordable Access to ChatGPT, Latest and Most Comprehensive Practical Tutorial!</a>.</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cloning into '/root/leveldb/third_party/googletest'...</span><br><span class="line">fatal: unable to access 'https://github.com/google/googletest.git/': GnuTLS recv error (-110): The TLS connection was non-properly terminated.</span><br><span class="line">fatal: clone of 'https://github.com/google/googletest.git' into submodule path '/root/leveldb/third_party/googletest' failed</span><br><span class="line">Failed to clone 'third_party/googletest'. Retry scheduled</span><br></pre></td></tr></tbody></table></figure>

<p>Next is compiling the entire source code. LevelDB uses cmake for building. To facilitate later code reading, we add <code>-DCMAKE_EXPORT_COMPILE_COMMANDS=1</code> during compilation, which will generate a <code>compile_commands.json</code> file. This file is a configuration file for tools like clangd and can help IDEs like VSCode better understand the code. With this file, features like code jumping and auto-completion will work better. Additionally, to facilitate debugging with GDB, we add <code>-DCMAKE_BUILD_TYPE=Debug</code> to generate libraries with debugging information.</p>
<p>You can refer to the complete command below:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone --recurse-submodules  git@github.com:google/leveldb.git</span><br><span class="line"></span><br><span class="line">cd leveldb</span><br><span class="line">mkdir -p build &amp;&amp; cd build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_INSTALL_PREFIX=$(pwd) .. &amp;&amp; cmake --build . --target install</span><br></pre></td></tr></tbody></table></figure>

<p>The <code>CMAKE_INSTALL_PREFIX</code> option is used to specify the installation directory. Here it’s specified as the current directory (build directory), so after compilation, the generated library files and header files will be placed in the build directory for convenient future use.</p>
<p>There are quite a few options for CMake building here. For example, <code>BUILD_SHARED_LIBS</code> is used to control whether the generated library is a static link library (.a file) or a dynamic link library (.so file). If <code>BUILD_SHARED_LIBS</code> is not explicitly set in CMakeLists.txt or through command-line arguments passed to CMake, CMake’s default behavior is usually not to enable shared library building. You can use <code>cmake -DBUILD_SHARED_LIBS=ON ..</code> on the command line to enable shared library building.</p>
<h2 id="IDE-Configuration"><a href="#IDE-Configuration" class="headerlink" title="IDE Configuration"></a>IDE Configuration</h2><p>I personally use vscode quite often. As a code IDE, vscode can be said to be very user-friendly. For C++ projects, although Microsoft provides an official <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">C++ plugin</a> for convenient code jumping and other features, from my personal experience, it’s not very user-friendly. Here, I strongly recommend using clangd to read C++ code. You only need to <strong>install Clangd on the server, then install the clangd plugin in vscode, and use it in conjunction with the compile_commands.json compilation database file generated by Cmake earlier</strong>.</p>
<p>Clangd is a language server based on the LLVM project, mainly supporting code analysis for C and C++. It can <strong>provide code completion, diagnostics (i.e., errors and warnings), code jumping, and code formatting features</strong>. Compared to Microsoft’s built-in C++ plugin, clangd responds very quickly and can achieve more precise jumping and warnings with the help of clang. It also supports using <code>clang-tidy</code> to perform static analysis on project code to discover potential errors.</p>
<p>For example, in the code below, clang-tidy found a suspicious issue: <code>Suspicious usage of 'sizeof(A*)'</code>, and also provided the clang-tidy check rule item <a target="_blank" rel="noopener" href="https://clang.llvm.org/extra/clang-tidy/checks/bugprone/sizeof-expression.html">bugprone-sizeof-expression</a>, which is used to check whether the use of <code>sizeof</code> expressions is correct.</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_clangd_tidy.png/webp" alt="Suspicious spot found by clangd plugin using clang-tidy" srcset="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_clangd_tidy.png/webp 3172w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_clangd_tidy.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_clangd_tidy.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_clangd_tidy.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="3172" height="1400"></p>
<p>Here, new_list itself is a pointer to a pointer, so new_list[0] is actually a pointer. sizeof(new_list[0]) is getting the size of the pointer, not the size of the element pointed to by the pointer. However, this is the intended design here, which is to set the initial value of the new bucket to nullptr. In fact, this rule is intended to prevent errors like the following:</p>
<blockquote>
<p>A common mistake is to compute the size of a pointer instead of its pointee. These cases may occur because of explicit cast or implicit conversion.</p>
</blockquote>
<p>For example, code like this:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> A[<span class="number">10</span>];</span><br><span class="line"><span class="built_in">memset</span>(A, <span class="number">0</span>, <span class="built_in">sizeof</span>(A + <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> point;</span><br><span class="line"><span class="built_in">memset</span>(point, <span class="number">0</span>, <span class="built_in">sizeof</span>(&amp;point));</span><br></pre></td></tr></tbody></table></figure>

<p>Overall, the code quality of LevelDB is very high, with very few clang-tidy prompts. It’s a world apart from business code, so it’s very worth learning.</p>
<h2 id="LevelDB-Read-Modify-Write"><a href="#LevelDB-Read-Modify-Write" class="headerlink" title="LevelDB Read, Modify, Write"></a>LevelDB Read, Modify, Write</h2><p>LevelDB is <strong>not a database like MySQL</strong>, nor does it support SQL queries and other features. It’s just a <strong>fast key-value storage library</strong>. LevelDB doesn’t come with client and server code. If you need to provide storage functionality, you need to implement the corresponding logic yourself. Additionally, it only supports single-process access to a specified database and does not support multi-process access.</p>
<p>In the industry, LevelDB is generally used as an underlying dependency for storage components. For example, WeChat’s core storage <a target="_blank" rel="noopener" href="https://github.com/Tencent/paxosstore">paxosstore</a> uses LevelDB to store data. Getting started with LevelDB is relatively simple. You just need to include the header file and then call the corresponding interfaces. The code below implements a simple command-line interface that uses the LevelDB library to read and write keys.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// simple_client.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"leveldb/db.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">  leveldb::DB* db;</span><br><span class="line">  leveldb::Options options;</span><br><span class="line">  options.create_if_missing = <span class="literal">true</span>;</span><br><span class="line">  leveldb::Status status = leveldb::DB::<span class="built_in">Open</span>(options, <span class="string">"./db"</span>, &amp;db);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) {</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">"Unable to open/create test database './db'"</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cerr &lt;&lt; status.<span class="built_in">ToString</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  std::string key;</span><br><span class="line">  std::string value;</span><br><span class="line">  std::string cmd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"leveldb&gt; "</span>;</span><br><span class="line">    std::cin &gt;&gt; cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmd == <span class="string">"set"</span>) {</span><br><span class="line">      std::cin &gt;&gt; key &gt;&gt; value;</span><br><span class="line">      status = db-&gt;<span class="built_in">Put</span>(leveldb::<span class="built_in">WriteOptions</span>(), key, value);</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"OK"</span> &lt;&lt; std::endl;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"Error setting value: "</span> &lt;&lt; status.<span class="built_in">ToString</span>() &lt;&lt; std::endl;</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="string">"get"</span>) {</span><br><span class="line">      std::cin &gt;&gt; key;</span><br><span class="line">      status = db-&gt;<span class="built_in">Get</span>(leveldb::<span class="built_in">ReadOptions</span>(), key, &amp;value);</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) {</span><br><span class="line">        std::cout &lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"Not found"</span> &lt;&lt; std::endl;</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="string">"del"</span>) {</span><br><span class="line">      std::cin &gt;&gt; key;</span><br><span class="line">      status = db-&gt;<span class="built_in">Delete</span>(leveldb::<span class="built_in">WriteOptions</span>(), key);</span><br><span class="line">      <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"OK"</span> &lt;&lt; std::endl;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"Error deleting key: "</span> &lt;&lt; status.<span class="built_in">ToString</span>() &lt;&lt; std::endl;</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="string">"exit"</span>) {</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      std::cout &lt;&lt; <span class="string">"Unknown command. Supported commands are: set, get, del, exit"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> db;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Here we use Cmake to build. You can refer to the following CMakeLists.txt file. Of course, the directories for include and lib libraries need to be changed according to the previously compiled directories.</p>
<figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"><span class="keyword">project</span>(SimpleLevelDBExamples VERSION <span class="number">1.0</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">True</span>)</span><br><span class="line"><span class="comment"># Set build type to Debug to include debugging information</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE Debug)</span><br><span class="line"><span class="keyword">add_executable</span>(SimpleClient simple_client.cpp)</span><br><span class="line"><span class="keyword">include_directories</span>(../build/<span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(SimpleClient <span class="variable">${CMAKE_SOURCE_DIR}</span>/../build/libleveldb.a pthread)</span><br></pre></td></tr></tbody></table></figure>

<p>Then you can use <code>cmake --build .</code> to compile the binary file. Of course, if you’re not used to cmake, you can also use gcc directly, but you need to manually specify the paths for header files and library files. Then execute as shown in the image below, you can operate LevelDB in a command-line client similar to redis.</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240806_leveldb_source_prepare_simpleclient.png/webp" alt="Simple read and write command-line interface for LevelDB" srcset="https://slefboot-1251736664.file.myqcloud.com/20240806_leveldb_source_prepare_simpleclient.png/webp 1872w, https://slefboot-1251736664.file.myqcloud.com/20240806_leveldb_source_prepare_simpleclient.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240806_leveldb_source_prepare_simpleclient.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240806_leveldb_source_prepare_simpleclient.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="1872" height="504"></p>
<p>You can see LevelDB’s data storage files in the db folder of the current directory, as follows:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> db</span> </span><br><span class="line">000005.ldb  000018.ldb  000020.ldb  000031.ldb  000036.log  CURRENT  LOCK  LOG  LOG.old  MANIFEST-000035</span><br></pre></td></tr></tbody></table></figure>

<p>We will explain LevelDB’s data storage method in detail later, and will also expand on the functions of these files. Let’s not go into details here.</p>
<h2 id="Running-Test-Cases"><a href="#Running-Test-Cases" class="headerlink" title="Running Test Cases"></a>Running Test Cases</h2><p>So far, we have compiled the LevelDB library and written a simple read and write command-line interface using LevelDB. Next, let’s look at LevelDB’s test cases. LevelDB’s core code all has corresponding test cases, such as <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/util/cache_test.cc">cache_test.cc</a> in LRU cache, <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/db/db_test.cc">db_test.cc</a> in db implementation, <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/table/table_test.cc">table_test.cc</a> in table, and so on. The executable file <code>build/leveldb_tests</code> for test cases is generated along with the library using the previous compilation command.</p>
<h3 id="Dynamic-Library-Dependencies"><a href="#Dynamic-Library-Dependencies" class="headerlink" title="Dynamic Library Dependencies"></a>Dynamic Library Dependencies</h3><p>If you run <code>leveldb_tests</code> directly, it may prompt that the <code>libtcmalloc</code> dynamic library is missing. This is a memory allocator from Google Perftools, which LevelDB uses and needs to be installed on the system.</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/leveldb_tests: error while loading shared libraries: libtcmalloc.so.4: cannot open shared object file: No such file or directory</span><br></pre></td></tr></tbody></table></figure>

<p>The installation command is also simple. For example, on a debian system, you can use the following command:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install libgoogle-perftools-dev</span><br></pre></td></tr></tbody></table></figure>

<p>After installation, you can use <code>ldd</code> to check if it can be found. If it’s normal as follows, you can run the binary.</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ldd ./build/leveldb_tests</span><br><span class="line">	linux-vdso.so.1 (0x00007ffc0d1fc000)</span><br><span class="line">	libtcmalloc.so.4 =&gt; /usr/local/lib/libtcmalloc.so.4 (0x00007f5277e91000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f5277c77000)</span><br><span class="line">	libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f5277b98000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f5277b78000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f5277997000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f52782ed000)</span><br></pre></td></tr></tbody></table></figure>

<p>Before installing the library, it prompted <code>libtcmalloc.so.4 =&gt; not found</code>, but after installing the dynamic library, it <strong>automatically linked</strong> to the correct path. How is this achieved? This is because the binary file contains references to dynamic libraries, especially <strong>the name of the library and the required symbols (functions or data)</strong>. The dynamic linker (usually <code>ld-linux.so</code> in Linux) is responsible for handling these references. It determines which libraries the binary file needs, and then loads the used libraries according to the specified paths and methods.</p>
<p>After we install the tcmalloc library, the dynamic library file libtcmalloc.so.4 is copied to the system’s library directory /usr/local/lib. Then the installation program executes ldconfig to update ld.so.cache, which contains path information for libraries to speed up library lookup. This way, when running the binary again, the dynamic linker checks the cache, finds the newly installed library, and resolves all relevant symbol references, thus completing the linking.</p>
<h3 id="Modifying-and-Running"><a href="#Modifying-and-Running" class="headerlink" title="Modifying and Running"></a>Modifying and Running</h3><p>These functional test cases are all written using the gtest framework. We can view all the test cases using the <code>--gtest_list_tests</code> parameter. As shown in the image below:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_list_tests.png/webp" alt="All current test cases for LevelDB" srcset="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_list_tests.png/webp 1948w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_list_tests.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_list_tests.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_list_tests.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="1948" height="1502"></p>
<p>If you run leveldb_tests directly, it will execute all the test cases. However, we can use the <code>--gtest_filter</code> parameter to specify running only certain test cases, for example, <code>--gtest_filter='CacheTest.*'</code> only runs the test cases related to LRU cache. The result is as follows:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test.png/webp" alt="Running only certain test cases" srcset="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test.png/webp 2022w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2022" height="1312"></p>
<p><strong>Test cases can help better understand the code logic.</strong> During the process of reading the code, sometimes we want to verify some logic, so we can modify the test cases a bit. For example, I deliberately broke a test case that could pass:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--- a/util/cache_test.cc</span><br><span class="line">+++ b/util/cache_test.cc</span><br><span class="line">@@ <span class="number">-69</span>,<span class="number">7</span> <span class="number">+69</span>,<span class="number">7</span> @@ <span class="built_in">TEST_F</span>(CacheTest, HitAndMiss) {</span><br><span class="line"></span><br><span class="line">   <span class="built_in">Insert</span>(<span class="number">100</span>, <span class="number">101</span>);</span><br><span class="line">   <span class="built_in">ASSERT_EQ</span>(<span class="number">101</span>, <span class="built_in">Lookup</span>(<span class="number">100</span>));</span><br><span class="line">-  <span class="built_in">ASSERT_EQ</span>(<span class="number">-1</span>, <span class="built_in">Lookup</span>(<span class="number">200</span>));</span><br><span class="line">+  <span class="built_in">ASSERT_EQ</span>(<span class="number">101</span>, <span class="built_in">Lookup</span>(<span class="number">200</span>));</span><br><span class="line">   <span class="built_in">ASSERT_EQ</span>(<span class="number">-1</span>, <span class="built_in">Lookup</span>(<span class="number">300</span>));</span><br><span class="line"></span><br><span class="line">   <span class="built_in">Insert</span>(<span class="number">200</span>, <span class="number">201</span>);</span><br><span class="line">(END)</span><br></pre></td></tr></tbody></table></figure>

<p>After modifying the test case, you need to recompile leveldb_tests. Because we configured the project’s compilation options during the previous compilation, CMake has already cached them, so the following command automatically uses the previous configuration items, such as -DCMAKE_BUILD_TYPE=Debug, etc.</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmake --build . --target leveldb_tests</span><br><span class="line"></span><br><span class="line">[  2%] Built target gtest</span><br><span class="line">[ 58%] Built target leveldb</span><br><span class="line">[ 61%] Built target gtest_main</span><br><span class="line">[ 64%] Built target gmock</span><br><span class="line">[ 65%] Building CXX object CMakeFiles/leveldb_tests.dir/util/cache_test.cc.o</span><br><span class="line">[ 67%] Linking CXX executable leveldb_tests</span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Built target leveldb_tests</span></span><br></pre></td></tr></tbody></table></figure>

<p>Note that from the output above, you can see that only the modified file was recompiled here, generating a new object file <code>cache_test.cc.o</code>, so the compilation speed is very fast. After running it again, you’ll see that the test case doesn’t pass, as shown below:</p>
<p><img src="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test_fail.png/webp" alt="Test case failing" srcset="https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test_fail.png/webp 2032w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test_fail.png/webp400 400w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test_fail.png/webp800 800w, https://slefboot-1251736664.file.myqcloud.com/20240515_leveldb_source_prepare_gtest_cache_test_fail.png/webp1600 1600w" sizes="(min-width: 1150px) 723px, (min-width: 48em) calc((100vw - 120px) * 3 / 4 - 50px), (min-width: 35.5em) calc((100vw - 75px), calc(100vw - 40px)" width="2032" height="1662"></p>
<p>You can see the specific reason for the test case validation failure. During the process of reading the code, you can modify the test cases of some code at any time to verify whether your understanding is correct.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Following this article, everyone should be able to quickly prepare the development environment for LevelDB. After configuring the IDE, compiling the source code, running simple read and write examples and test cases, let’s start reading the source code together!</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/C/"><i class="fa fa-tag"></i>C++</a><a href="/tags/LevelDB/"><i class="fa fa-tag"></i>LevelDB</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2024/08/06/leveldb_source_prepare/';
    this.page.identifier = 'en/2024/08/06/leveldb_source_prepare/';
    this.page.title = 'LevelDB Explained - Preparing the Development Environment';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });</script></div><script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
  var disqusThread = document.getElementById('disqus_thread');
  if (!disqusThread) return;
  
  function removeAdIframes() {
    var iframes = disqusThread.getElementsByTagName('iframe');
    for (var i = iframes.length - 1; i >= 0; i--) {
      var iframe = iframes[i];
      if (iframe.src && iframe.src.indexOf("tempest.services.disqus.com/ads-iframe") !== -1) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  }
  
  removeAdIframes();
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      removeAdIframes();
    });
  });
  observer.observe(disqusThread, { childList: true, subtree: true });
});
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (17)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (13)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2024/08/06/leveldb_source_prepare/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/01/24/leveldb_source_writedb/" title="LevelDB Explained - Implementation and Optimization Details of Key-Value Writing">LevelDB Explained - Implementation and Optimization Details of Key-Value Writing</a></li><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li><li><a href="/en/2024/09/24/leveldb_source_skiplist_time_analysis/" title="LevelDB Explained - How to Analyze the Time Complexity of SkipLists?">LevelDB Explained - How to Analyze the Time Complexity of SkipLists?</a></li><li><a href="/en/2024/09/18/leveldb_source_skiplist_test/" title="LevelDB Explained - How to Test Parallel Read and Write of SkipLists?">LevelDB Explained - How to Test Parallel Read and Write of SkipLists?</a></li><li><a href="/en/2024/09/13/gpto1_hands_on/" title="Hands-on with OpenAI's o1-preview - Not Better Enough?">Hands-on with OpenAI's o1-preview - Not Better Enough?</a></li><li><a href="/en/2024/09/09/leveldb_source_skiplist/" title="LevelDB Explained - How to implement SkipList">LevelDB Explained - How to implement SkipList</a></li><li><a href="/en/2024/09/05/claude35_prompt/" title="Claude3.5's System Prompts - No Apologies, Face Blind, Hallucinate...">Claude3.5's System Prompts - No Apologies, Face Blind, Hallucinate...</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-Code-Compilation"><span class="toc-number">1.</span> <span class="toc-text">Source Code Compilation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDE-Configuration"><span class="toc-number">2.</span> <span class="toc-text">IDE Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LevelDB-Read-Modify-Write"><span class="toc-number">3.</span> <span class="toc-text">LevelDB Read, Modify, Write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Running-Test-Cases"><span class="toc-number">4.</span> <span class="toc-text">Running Test Cases</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-Library-Dependencies"><span class="toc-number">4.1.</span> <span class="toc-text">Dynamic Library Dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-and-Running"><span class="toc-number">4.2.</span> <span class="toc-text">Modifying and Running</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary"><span class="toc-number">5.</span> <span class="toc-text">Summary</span></a></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>