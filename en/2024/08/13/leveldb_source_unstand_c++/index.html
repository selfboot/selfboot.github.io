<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="baidu-site-verification" content="codeva-NxrUEx2EFN"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This article delves into the advanced C++ techniques used in LevelDB, including flexible arrays, symbol exporting for linking, and the Pimpl class design. Through specific code examples, it explains in detail how to implement variable-length data structures using flexible arrays, optimizing memory usage and reducing memory fragmentation. It also introduces different methods of symbol exporting and their importance for cross-platform compilation, as well as the application of the Pimpl design pattern in encapsulation and binary compatibility."><title>LevelDB Explained -  Understanding Advanced C++ Techniques</title><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,en/atom.xml"><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;973c5bad683a49b8af76df256779f523&quot;}"></script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="3578d9f2-9ea0-49d4-8781-e8d1217ab924" data-domains="selfboot.cn"></script><script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="referrer" content="no-referrer-when-downgrade"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QNFB9JLSPV"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QNFB9JLSPV');
</script><script async="" type="text/javascript" src="/js/clipboard.min.js"></script><script async="" type="text/javascript" src="/js/toastr.min.js"></script><link rel="stylesheet" href="/css/toastr.min.css"><script>function switchLanguage(lang) {
  var currentPath = window.location.pathname;
  var newPath;
  if (lang === 'en') {
    newPath = '/en' + currentPath.replace(/^\/(zh-CN\/)?/, '/');
  } else {
    newPath = currentPath.replace(/^\/en/, '');
  }
  window.location.href = newPath;
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><a id="logo" href="/.">Just For Fun</a><div class="lang-select-wrapper"><i class="fas fa-globe"></i><select id="lang-select" onchange="switchLanguage(this.value)"><option value="zh-CN">中文</option><option value="en" selected="">English</option></select></div><p class="description">Know what it is, and know why it is so. The breadth of knowledge is a byproduct of its depth!</p></div><div id="nav-menu"><a href="/en/."><i class="fa fa-home"></i><span> Home</span></a><a href="/en/archives/"><i class="fa fa-archive"></i><span> Archive</span></a><a href="/en/aboutme.html"><i class="fa fa-user"></i><span> About</span></a><a href="/en/atom.xml"><i class="fa fa-rss"></i><span> RSS</span></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">LevelDB Explained -  Understanding Advanced C++ Techniques</h1><div class="post-meta">2024/08/13<span> | </span><span class="category"><a href="/categories/Source-Code-Analysis/">Source Code Analysis</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" data-disqus-identifier="en/2024/08/13/leveldb_source_unstand_c++/" href="/en/2024/08/13/leveldb_source_unstand_c++/#disqus_thread"></a><div class="post-content"><p>The overall code of LevelDB is quite understandable, <strong>without using many esoteric C++ techniques</strong>. However, there are some implementations that are relatively uncommon, such as flexible arrays, symbol exporting for linking, and Pimpl class design. This article will review these advanced C++ techniques to help better understand the implementation of LevelDB.</p>
<h2 id="Flexible-Arrays"><a href="#Flexible-Arrays" class="headerlink" title="Flexible Arrays"></a>Flexible Arrays</h2><p>In the LRUHandle structure definition in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/util/cache.cc">util/cache.cc</a>, there’s a flexible array member <code>char key_data[1]</code>, used to implement <strong>variable-length data structures</strong> in C/C++.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">LRUHandle</span> {</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="type">char</span> key_data[<span class="number">1</span>];  <span class="comment">// Beginning of key</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Slice <span class="title">key</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">    <span class="built_in">assert</span>(next != <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Slice</span>(key_data, key_length);</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<span id="more"></span>

<p>In this handle structure, <code>key_data[1]</code> is actually just a placeholder. The space actually allocated to <code>key_data</code> is larger than 1 byte, determined by the total_size calculated during malloc. Specifically, in LevelDB’s implementation, when inserting a new cache entry, memory is dynamically allocated based on the length of the key, and then the content of the key is copied into this memory. The code is as follows:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Cache::Handle* <span class="title">LRUCache::Insert</span><span class="params">(<span class="type">const</span> Slice&amp; key, <span class="type">uint32_t</span> hash, <span class="type">void</span>* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">size_t</span> charge,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">void</span> (*deleter)(<span class="type">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="type">void</span>* value))</span> </span>{</span><br><span class="line">  <span class="function">MutexLock <span class="title">l</span><span class="params">(&amp;mutex_)</span></span>;</span><br><span class="line">  <span class="comment">// Calculate the total memory size needed. Note that 1 is subtracted here because key_data[1] is a placeholder, already having one byte</span></span><br><span class="line">  LRUHandle* e = <span class="built_in">reinterpret_cast</span>&lt;LRUHandle*&gt;(<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(LRUHandle) - <span class="number">1</span> + key.<span class="built_in">size</span>()));</span><br><span class="line">  e-&gt;value = value;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  e-&gt;refs = <span class="number">1</span>;  <span class="comment">// for the returned handle.</span></span><br><span class="line">  <span class="comment">// Copy key data into key_data</span></span><br><span class="line">  std::<span class="built_in">memcpy</span>(e-&gt;key_data, key.<span class="built_in">data</span>(), key.<span class="built_in">size</span>());</span><br><span class="line">  <span class="comment">// ... omitted</span></span><br></pre></td></tr></tbody></table></figure>

<p>The code above allocates <strong>contiguous memory</strong> for both the LRUHandle structure and the trailing key_data array in a single malloc call. This avoids allocating memory separately for the key data, thereby <strong>reducing additional memory allocation overhead and potential memory fragmentation issues</strong>. At the same time, the entire data structure of LRUHandle is compactly stored in a contiguous block of memory, improving space utilization and potentially enhancing cache locality. If std::vector or std::string were used instead, it would require two memory allocations for each LRUHandle object: one for the LRUHandle object itself, and one for the dynamically allocated memory by std::vector or std::string to store the data. In a high-performance database implementation, such memory allocation overhead is not negligible.</p>
<p>Furthermore, the array length at the end of the structure here is 1. In many other code examples, <strong>the trailing array length is 0 or not written at all</strong>. What’s the difference between these two methods? In fact, both approaches are used to add variable-length data at the end of a structure. <code>char key_data[];</code> is a more explicit way of declaring a trailing array, directly indicating that the array itself doesn’t allocate any space, introduced in the C99 standard. However, this declaration is not legal in some standard C++ versions, although some compilers may support it as an extension. In C++, to avoid compatibility issues, it’s usually recommended to use <code>char key_data[1];</code>, as it typically has better support in compilers.</p>
<p>There are some discussions about this that you can refer to: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/14643406/whats-the-need-of-array-with-zero-elements">What’s the need of array with zero elements?</a> and <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4559558/one-element-array-in-struct">One element array in struct</a>.</p>
<h2 id="Symbol-Exporting-for-Linking"><a href="#Symbol-Exporting-for-Linking" class="headerlink" title="Symbol Exporting for Linking"></a>Symbol Exporting for Linking</h2><p>In many classes in include/leveldb, such as the <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/include/leveldb/db.h#L46">DB class</a> in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/include/leveldb/db.h">db.h</a>, the definition includes a macro <code>LEVELDB_EXPORT</code>, as follows:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LEVELDB_EXPORT</span> DB {</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line"> ...</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>The definition of this macro is in <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/include/leveldb/export.h">include/leveldb/export.h</a>, with many compilation option branches. For ease of reading, indentation has been added below (the actual code doesn’t have it):</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(LEVELDB_EXPORT)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(LEVELDB_SHARED_LIBRARY)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> defined(_WIN32)</span></span><br><span class="line">            <span class="meta">#<span class="keyword">if</span> defined(LEVELDB_COMPILE_LIBRARY)</span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> LEVELDB_EXPORT __declspec(dllexport)</span></span><br><span class="line">            <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> LEVELDB_EXPORT __declspec(dllimport)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span>  <span class="comment">// defined(LEVELDB_COMPILE_LIBRARY)</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">else</span>  <span class="comment">// defined(_WIN32)</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">if</span> defined(LEVELDB_COMPILE_LIBRARY)</span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> LEVELDB_EXPORT __attribute__((visibility(<span class="string">"default"</span>)))</span></span><br><span class="line">        <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> LEVELDB_EXPORT</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span>  <span class="comment">// defined(_WIN32)</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">else</span>  <span class="comment">// defined(LEVELDB_SHARED_LIBRARY)</span></span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> LEVELDB_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// !defined(LEVELDB_EXPORT)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>We know that leveldb itself doesn’t provide database services like MySQL or PostgreSQL; it’s just a library that we can link to for reading and writing data. To export leveldb as a dynamic link library, it’s necessary to control the visibility and linking attributes of symbols. To support cross-platform builds, different attributes are specified based on different platform information.</p>
<p>On Linux systems, when compiling the library, if LEVELDB_COMPILE_LIBRARY is defined, the <code>__attribute__((visibility("default")))</code> attribute will be added. This sets the linking visibility of the symbol to default, so that other code linking to this shared library can use this class.</p>
<p>What’s the problem if we don’t use this macro to export symbols? In the Linux environment, <strong>all symbols are visible by default</strong>, which will export more symbols. This not only increases the size of the library but may also conflict with symbols in other libraries. Hiding some symbols that are not intended for public use can help the linker optimize the program, <strong>improving loading speed and reducing memory usage</strong>. Moreover, through export macros, we can explicitly control which interfaces are public and which are private, <strong>hiding implementation details to achieve good encapsulation</strong>.</p>
<p>When <code>LEVELDB_SHARED_LIBRARY</code> is not defined, the LEVELDB_EXPORT macro <strong>is defined as empty</strong>, which means that when leveldb is compiled as a static library, all symbols that might otherwise need special export/import markers don’t need such markers. In the case of static linking, symbol exporting is not necessary for the linking process because the code of the static library will be directly included in the final binary file during compilation.</p>
<h2 id="Pimpl-Class-Design"><a href="#Pimpl-Class-Design" class="headerlink" title="Pimpl Class Design"></a>Pimpl Class Design</h2><p>In many classes in LevelDB, there is only one private member variable of pointer type. For example, in the TableBuild class definition in the include/leveldb/table_builder.h header file, there is a private member variable Rep *rep_, which is a pointer to the Rep structure:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line"> <span class="keyword">struct</span> <span class="title class_">Rep</span>;</span><br><span class="line"> Rep* rep_;</span><br></pre></td></tr></tbody></table></figure>

<p>Then in the <a target="_blank" rel="noopener" href="https://github.com/google/leveldb/blob/main/table/table_builder.cc">table/table_builder.cc</a> file, the Rep structure is defined:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TableBuilder</span>::Rep {</span><br><span class="line">  <span class="built_in">Rep</span>(<span class="type">const</span> Options&amp; opt, WritableFile* f)</span><br><span class="line">      : <span class="built_in">options</span>(opt),</span><br><span class="line">        <span class="built_in">index_block_options</span>(opt),</span><br><span class="line">        <span class="built_in">file</span>(f),</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>Why not directly define the Rep structure in the header file</strong>? In fact, this is using the <strong>Pimpl (Pointer to Implementation)</strong> design pattern, which has several advantages:</p>
<ul>
<li><strong>Binary compatibility</strong> (ABI stability). When the TableBuilder class library is updated, as long as its interface (.h file) remains unchanged, even if members are added to the Rep structure in the implementation or the implementation of the interface is changed, applications depending on this library <strong>only need to update the dynamic library file, without recompilation</strong>. If binary compatibility is not achieved, for example, if some member variables are added to a public class, and the application only updates the dynamic library without recompiling, it will cause the program to crash at runtime due to inconsistent object memory distribution. You can refer to a similar problem encountered in a previous business scenario, <a href="https://selfboot.cn/en/2024/03/15/object_memory_coredump/">Analysis of C++ Process Coredump Caused by Missing Bazel Dependencies</a>.</li>
<li><strong>Reduced compilation dependencies</strong>. If the definition of the Rep structure is in the header file, any modification to the Rep structure would cause files that include table_builder.h to be recompiled. By putting the definition of the Rep structure in the source file, only table_builder.cc needs to be recompiled.</li>
<li><strong>Separation of interface and implementation</strong>. The interface (public methods defined in the .h file) and the implementation (the Rep structure and specific implementation defined in the .cc file) are completely separate. This allows developers to freely modify implementation details, such as adding new private member variables or modifying internal logic, without changing the public interface.</li>
</ul>
<p><strong>Why do these advantages exist after using member pointers</strong>? This comes down to the memory layout of C++ objects. The layout of an object of a class in memory is contiguous and directly includes all of its non-static member variables. If the member variables are simple types (like int, double, etc.) or objects of other classes, these members will be directly embedded into the object’s memory layout. You can refer to my previous article <a href="https://selfboot.cn/en/2024/05/10/c++_object_model/">In-depth Understanding of C++ Object Memory Layout with Examples</a> for more information.</p>
<p>When a member variable is a pointer to another class, its layout in memory is just a pointer (Impl* pImpl), not the specific class object. The <strong>size and alignment of this pointer are fixed, regardless of what data Impl contains</strong>. Therefore, no matter how the internal implementation of the class corresponding to the pointer changes (e.g., adding or removing data members, changing the types of members, etc.), the size and layout of the external class remain unchanged and unaffected.</p>
<p>In “Effective C++”, Item 31 mentions using this approach to reduce compilation dependencies:</p>
<blockquote>
<p>If you can accomplish a task with object references or pointers, don’t use objects. You can define references and pointers to a type with just a type declaration; but if you define objects of a type, you need the type’s definition.</p>
</blockquote>
<p>Of course, there’s no silver bullet in software development, and these advantages come with corresponding costs. Refer to <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/pimpl">cppreference.com: PImpl</a>:</p>
<ul>
<li><strong>Lifecycle management overhead (Runtime Overhead)</strong>: Pimpl typically requires dynamically allocating memory on the heap to store the implementation object (Impl object). This dynamic allocation is <strong>slower than allocating objects on the stack</strong> (usually a faster allocation method) and involves more complex memory management. Additionally, allocating memory on the heap can cause memory leaks if not released. However, in the above example, Rep is allocated during object construction and released during destruction, so it won’t cause memory leaks.</li>
<li><strong>Access overhead</strong>: Each time a private member function or variable is accessed through Pimpl, it requires indirect access through a pointer.</li>
<li><strong>Space overhead</strong>: Each class using Pimpl will add at least one pointer’s worth of space overhead in its object to store the implementation pointer. If the implementation part needs to access public members, additional pointers may be needed or pointers may need to be passed as parameters.</li>
</ul>
<p>Overall, Pimpl is a good design pattern for basic libraries. You can also refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8972588/is-the-pimpl-idiom-really-used-in-practice">Is the PIMPL idiom really used in practice?</a> for more discussion.</p>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><h3 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h3><p><code>constexpr</code> specifies variables or functions used to declare constant expressions. The purpose of this declaration is to inform the compiler that <strong>this value or function is known at compile time</strong>, allowing for more optimization and checks during compilation.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int</span> kCacheSize = <span class="number">1000</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>Compared to const, constexpr emphasizes compile-time constants, while const variables are initialized at the time of declaration, but they <strong>don’t necessarily have to be determined at compile time</strong>, usually just indicating that they cannot be modified at runtime.</p>
</div><div class="article-footer-copyright"><p> Written in Chinese, LLM translated into English</p><p>Non-commercial reproduction is allowed with proper attribution to the author and source. </p><p>For commercial reproduction, please contact the <a href="mailto:xuezaigds@gmail.com">author</a></p></div><div class="post-donate"><div class="donate_bar center" id="donate_board"><a class="btn_donate" id="btn_donate" href="javascript:;" title="Sponsor"></a><div class="donate_txt"> ↑<br>Good content, Sponsor it<br></div></div><div class="donate_bar center hidden" id="donate_guide"><img src="https://slefboot-1251736664.file.myqcloud.com/weixin.jpg" title="WeChat Sponsor"><img src="https://slefboot-1251736664.file.myqcloud.com/zhifubao.jpg" title="Alipay Sponsor"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div><div class="addthis_sharing_toolbox"></div><div class="tags"><a href="/tags/C/"><i class="fa fa-tag"></i>C++</a><a href="/tags/LevelDB/"><i class="fa fa-tag"></i>LevelDB</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://selfboot.cn/en/2024/08/13/leveldb_source_unstand_c++/';
    this.page.identifier = 'en/2024/08/13/leveldb_source_unstand_c++/';
    this.page.title = 'LevelDB Explained -  Understanding Advanced C++ Techniques';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//xuelangZF.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//xuelangZF.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://xuelangZF.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });</script></div><script type="text/javascript">document.addEventListener('DOMContentLoaded', function () {
  var disqusThread = document.getElementById('disqus_thread');
  if (!disqusThread) return;
  
  function removeAdIframes() {
    var iframes = disqusThread.getElementsByTagName('iframe');
    for (var i = iframes.length - 1; i >= 0; i--) {
      var iframe = iframes[i];
      if (iframe.src && iframe.src.indexOf("tempest.services.disqus.com/ads-iframe") !== -1) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  }
  
  removeAdIframes();
  
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      removeAdIframes();
    });
  });
  observer.observe(disqusThread, { childList: true, subtree: true });
});
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="https://www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://selfboot.cn"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Categories</span></div><ul><li><a href="/en/categories/Programming/">Programming</a> (19)</li><li><a href="/en/categories/Source-Code-Analysis/">Source Code Analysis</a> (20)</li><li><a href="/en/categories/Artificial-Intelligence/">Artificial Intelligence</a> (14)</li><li><a href="/en/categories/Discovery/">Discovery</a> (1)</li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"></i><span>Tags</span></div><div class="tagcloud"><a href="/en/tags/Python/" style="font-size: 15.00px;">Python</a> <a href="/en/tags/Google/" style="font-size: 15.00px;">Google</a> <a href="/en/tags/C/" style="font-size: 15.00px;">C++</a> <a href="/en/tags/ChatGPT/" style="font-size: 15.00px;">ChatGPT</a> <a href="/en/tags/Prompt/" style="font-size: 15.00px;">Prompt</a> <a href="/en/tags/Redis/" style="font-size: 15.00px;">Redis</a> <a href="/en/tags/Debug/" style="font-size: 15.00px;">Debug</a> <a href="/en/tags/eBPF/" style="font-size: 15.00px;">eBPF</a> <a href="/en/tags/Go/" style="font-size: 15.00px;">Go</a> <a href="/en/tags/Frontend/" style="font-size: 15.00px;">Frontend</a> <a href="/en/tags/Gemini/" style="font-size: 15.00px;">Gemini</a> <a href="/en/tags/SEO/" style="font-size: 15.00px;">SEO</a> <a href="/en/tags/LLM/" style="font-size: 15.00px;">LLM</a> <a href="/en/tags/Web/" style="font-size: 15.00px;">Web</a> <a href="/en/tags/LevelDB/" style="font-size: 15.00px;">LevelDB</a></div></div><!-- Debug: page.path = en/2024/08/13/leveldb_source_unstand_c++/ --><div class="widget"><div class="widget-title"><i class="fa fa-file-o"></i><span>Recent</span></div><ul><li><a href="/en/2025/06/13/leveldb_source_LRU_cache/" title="LevelDB Explained - The Implementation Details of a High-Performance LRU Cache">LevelDB Explained - The Implementation Details of a High-Performance LRU Cache</a></li><li><a href="/en/2025/06/11/leveldb_source_memtable/" title="LevelDB Explained - The Implementation Details of MemTable">LevelDB Explained - The Implementation Details of MemTable</a></li><li><a href="/en/2025/06/10/leveldb_mvcc_intro/" title="LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)">LevelDB Explained - Understanding Multi-Version Concurrency Control (MVCC)</a></li><li><a href="/en/2025/05/23/mcp_user_report/" title="In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?">In-depth Experience with 3 MCP Servers via Cursor: Impressive but Not Yet Practical?</a></li><li><a href="/en/2025/01/24/leveldb_source_writedb/" title="LevelDB Explained - Implementation and Optimization Details of Key-Value Writing">LevelDB Explained - Implementation and Optimization Details of Key-Value Writing</a></li><li><a href="/en/2025/01/13/leveldb_source_write_batch/" title="LevelDB Explained - Elegant Merging of Write and Delete Operations">LevelDB Explained - Elegant Merging of Write and Delete Operations</a></li><li><a href="/en/2025/01/10/c++_crash_cases/" title="5 Real-world Cases of C++ Process Crashes from Production">5 Real-world Cases of C++ Process Crashes from Production</a></li><li><a href="/en/2025/01/02/leveldb_source_thread_anno/" title="LevelDB Explained - Static Thread Safety Analysis with Clang">LevelDB Explained - Static Thread Safety Analysis with Clang</a></li><li><a href="/en/2024/12/25/leveldb_source_hashtable/" title="LevelDB Explained - How to Design a High-Performance HashTable">LevelDB Explained - How to Design a High-Performance HashTable</a></li><li><a href="/en/2024/09/24/leveldb_source_skiplist_time_analysis/" title="LevelDB Explained - How to Analyze the Time Complexity of SkipLists?">LevelDB Explained - How to Analyze the Time Complexity of SkipLists?</a></li></ul></div><!-- Debug: Current Language = en, Filtered Posts Count = 10 --><div class="widget" id="toc"><div class="widget-title"><i class="fa fa-list-ul"></i><span> Contents</span></div><ul class="dsq-widget-list"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flexible-Arrays"><span class="toc-number">1.</span> <span class="toc-text">Flexible Arrays</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Symbol-Exporting-for-Linking"><span class="toc-number">2.</span> <span class="toc-text">Symbol Exporting for Linking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pimpl-Class-Design"><span class="toc-number">3.</span> <span class="toc-text">Pimpl Class Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Others"><span class="toc-number">4.</span> <span class="toc-text">Others</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#constexpr"><span class="toc-number">4.1.</span> <span class="toc-text">constexpr</span></a></li></ol></li></ol></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Just For Fun.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/selfboot/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/selfboot"> SelfBoot.</a><p><span id="busuanzi_container_site_pv"></span>Total Site Visits:  <span id="busuanzi_value_site_pv"></span> Times，<span id="busuanzi_container_site_uv"></span>Unique Visitors:  <span id="busuanzi_value_site_uv"></span> People</p><p>Friend Link:<a rel="dofollow" target="_blank" href="https://puzzles-game.com/">Puzzle Games</a></p></div></div></div><link rel="stylesheet" type="text/css" href="/css/donate.css"><link rel="stylesheet" type="text/css" href="/css/copyright.css"><a class="show" id="rocket" href="#top" aria-label="Back to top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script><script type="text/javascript" src="/js/jquery.fancybox.min.js" defer=""></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" defer=""></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css"><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>